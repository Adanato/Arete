/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository
*/

var wt=Object.create;var ce=Object.defineProperty;var kt=Object.getOwnPropertyDescriptor;var St=Object.getOwnPropertyNames;var Ct=Object.getPrototypeOf,xt=Object.prototype.hasOwnProperty;var Pt=(a,n)=>{for(var e in n)ce(a,e,{get:n[e],enumerable:!0})},He=(a,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of St(n))!xt.call(a,s)&&s!==e&&ce(a,s,{get:()=>n[s],enumerable:!(t=kt(n,s))||t.enumerable});return a};var q=(a,n,e)=>(e=a!=null?wt(Ct(a)):{},He(n||!a||!a.__esModule?ce(e,"default",{value:a,enumerable:!0}):e,a)),Tt=a=>He(ce({},"__esModule",{value:!0}),a);var ks={};Pt(ks,{default:()=>De});module.exports=Tt(ks);var T=require("obsidian"),Te=q(require("path"));var je={python_path:"python3",arete_script_path:"",debug_mode:!1,backend:"auto",workers:4,anki_connect_url:"http://localhost:8765",anki_media_dir:"",renderer_mode:"obsidian",stats_algorithm:"fsrs",stats_lapse_threshold:3,stats_ease_threshold:2100,stats_difficulty_threshold:.9,sync_on_save:!1,sync_on_save_delay:2e3,ui_expanded_decks:[],ui_expanded_concepts:[],last_sync_time:null,graph_coloring_enabled:!1,graph_tag_prefix:"arete/retention",execution_mode:"cli",server_port:8777,server_reload:!1,ai_api_key:"",ai_provider:"openai",project_root:""};var x=require("obsidian"),V=require("@codemirror/view"),pe=require("@codemirror/state"),G=require("@codemirror/commands");var X=require("@lezer/lr"),C=require("@lezer/highlight"),H=63,Ge=64,Dt=1,At=2,Ke=3,Et=4,Je=5,_t=6,Rt=7,et=65,Qt=66,Lt=8,$t=9,Mt=10,It=11,Ft=12,tt=13,Xt=19,Vt=20,Nt=29,Bt=33,Wt=34,Yt=47,Ut=0,Le=1,Ee=2,se=3,_e=4,I=class{constructor(n,e,t){this.parent=n,this.depth=e,this.type=t,this.hash=(n?n.hash+n.hash<<8:0)+e+(e<<4)+t}};I.top=new I(null,-1,Ut);function te(a,n){for(let e=0,t=n-a.pos-1;;t--,e++){let s=a.peek(t);if(F(s)||s==-1)return e}}function Re(a){return a==32||a==9}function F(a){return a==10||a==13}function st(a){return Re(a)||F(a)}function U(a){return a<0||st(a)}var qt=new X.ContextTracker({start:I.top,reduce(a,n){return a.type==se&&(n==Vt||n==Wt)?a.parent:a},shift(a,n,e,t){if(n==Ke)return new I(a,te(t,t.pos),Le);if(n==et||n==Je)return new I(a,te(t,t.pos),Ee);if(n==H)return a.parent;if(n==Xt||n==Bt)return new I(a,0,se);if(n==tt&&a.type==_e)return a.parent;if(n==Yt){let s=/[1-9]/.exec(t.read(t.pos,e.pos));if(s)return new I(a,a.depth+ +s[0],_e)}return a},hash(a){return a.hash}});function j(a,n,e=0){return a.peek(e)==n&&a.peek(e+1)==n&&a.peek(e+2)==n&&U(a.peek(e+3))}var Ht=new X.ExternalTokenizer((a,n)=>{if(a.next==-1&&n.canShift(Ge))return a.acceptToken(Ge);let e=a.peek(-1);if((F(e)||e<0)&&n.context.type!=se){if(j(a,45))if(n.canShift(H))a.acceptToken(H);else return a.acceptToken(Dt,3);if(j(a,46))if(n.canShift(H))a.acceptToken(H);else return a.acceptToken(At,3);let t=0;for(;a.next==32;)t++,a.advance();(t<n.context.depth||t==n.context.depth&&n.context.type==Le&&(a.next!=45||!U(a.peek(1))))&&a.next!=-1&&!F(a.next)&&a.next!=35&&a.acceptToken(H,-t)}},{contextual:!0}),jt=new X.ExternalTokenizer((a,n)=>{if(n.context.type==se){a.next==63&&(a.advance(),U(a.next)&&a.acceptToken(Rt));return}if(a.next==45)a.advance(),U(a.next)&&a.acceptToken(n.context.type==Le&&n.context.depth==te(a,a.pos-1)?Et:Ke);else if(a.next==63)a.advance(),U(a.next)&&a.acceptToken(n.context.type==Ee&&n.context.depth==te(a,a.pos-1)?_t:Je);else{let e=a.pos;for(;;)if(Re(a.next)){if(a.pos==e)return;a.advance()}else if(a.next==33)rt(a);else if(a.next==38)Qe(a);else if(a.next==42){Qe(a);break}else if(a.next==39||a.next==34){if($e(a,!0))break;return}else if(a.next==91||a.next==123){if(!zt(a))return;break}else{nt(a,!0,!1,0);break}for(;Re(a.next);)a.advance();if(a.next==58){if(a.pos==e&&n.canShift(Nt))return;let t=a.peek(1);U(t)&&a.acceptTokenTo(n.context.type==Ee&&n.context.depth==te(a,e)?Qt:et,e)}}},{contextual:!0});function Gt(a){return a>32&&a<127&&a!=34&&a!=37&&a!=44&&a!=60&&a!=62&&a!=92&&a!=94&&a!=96&&a!=123&&a!=124&&a!=125}function ze(a){return a>=48&&a<=57||a>=97&&a<=102||a>=65&&a<=70}function Ze(a,n){return a.next==37?(a.advance(),ze(a.next)&&a.advance(),ze(a.next)&&a.advance(),!0):Gt(a.next)||n&&a.next==44?(a.advance(),!0):!1}function rt(a){if(a.advance(),a.next==60){for(a.advance();;)if(!Ze(a,!0)){a.next==62&&a.advance();break}}else for(;Ze(a,!1););}function Qe(a){for(a.advance();!U(a.next)&&le(a.tag)!="f";)a.advance()}function $e(a,n){let e=a.next,t=!1,s=a.pos;for(a.advance();;){let r=a.next;if(r<0)break;if(a.advance(),r==e)if(r==39)if(a.next==39)a.advance();else break;else break;else if(r==92&&e==34)a.next>=0&&a.advance();else if(F(r)){if(n)return!1;t=!0}else if(n&&a.pos>=s+1024)return!1}return!t}function zt(a){for(let n=[],e=a.pos+1024;;)if(a.next==91||a.next==123)n.push(a.next),a.advance();else if(a.next==39||a.next==34){if(!$e(a,!0))return!1}else if(a.next==93||a.next==125){if(n[n.length-1]!=a.next-2)return!1;if(n.pop(),a.advance(),!n.length)return!0}else{if(a.next<0||a.pos>e||F(a.next))return!1;a.advance()}}var Zt="iiisiiissisfissssssssssssisssiiissssssssssssssssssssssssssfsfssissssssssssssssssssssssssssfif";function le(a){return a<33?"u":a>125?"s":Zt[a-33]}function Ae(a,n){let e=le(a);return e!="u"&&!(n&&e=="f")}function nt(a,n,e,t){if(le(a.next)=="s"||(a.next==63||a.next==58||a.next==45)&&Ae(a.peek(1),e))a.advance();else return!1;let s=a.pos;for(;;){let r=a.next,i=0,o=t+1;for(;st(r);){if(F(r)){if(n)return!1;o=0}else o++;r=a.peek(++i)}if(!(r>=0&&(r==58?Ae(a.peek(i+1),e):r==35?a.peek(i-1)!=32:Ae(r,e)))||!e&&o<=t||o==0&&!e&&(j(a,45,i)||j(a,46,i)))break;if(n&&le(r)=="f")return!1;for(let d=i;d>=0;d--)a.advance();if(n&&a.pos>s+1024)return!1}return!0}var Kt=new X.ExternalTokenizer((a,n)=>{if(a.next==33)rt(a),a.acceptToken(Ft);else if(a.next==38||a.next==42){let e=a.next==38?Mt:It;Qe(a),a.acceptToken(e)}else a.next==39||a.next==34?($e(a,!1),a.acceptToken($t)):nt(a,!1,n.context.type==se,n.context.depth)&&a.acceptToken(Lt)}),Jt=new X.ExternalTokenizer((a,n)=>{let e=n.context.type==_e?n.context.depth:-1,t=a.pos;e:for(;;){let s=0,r=a.next;for(;r==32;)r=a.peek(++s);if(!s&&(j(a,45,s)||j(a,46,s))||!F(r)&&(e<0&&(e=Math.max(n.context.depth+1,s)),s<e))break;for(;;){if(a.next<0)break e;let i=F(a.next);if(a.advance(),i)continue e;t=a.pos}}a.acceptTokenTo(tt,t)}),es=(0,C.styleTags)({DirectiveName:C.tags.keyword,DirectiveContent:C.tags.attributeValue,"DirectiveEnd DocEnd":C.tags.meta,QuotedLiteral:C.tags.string,BlockLiteralHeader:C.tags.special(C.tags.string),BlockLiteralContent:C.tags.content,Literal:C.tags.content,"Key/Literal Key/QuotedLiteral":C.tags.definition(C.tags.propertyName),"Anchor Alias":C.tags.labelName,Tag:C.tags.typeName,Comment:C.tags.lineComment,": , -":C.tags.separator,"?":C.tags.punctuation,"[ ]":C.tags.squareBracket,"{ }":C.tags.brace}),at=X.LRParser.deserialize({version:14,states:"5lQ!ZQgOOO#PQfO'#CpO#uQfO'#DOOOQR'#Dv'#DvO$qQgO'#DRO%gQdO'#DUO%nQgO'#DUO&ROaO'#D[OOQR'#Du'#DuO&{QgO'#D^O'rQgO'#D`OOQR'#Dt'#DtO(iOqO'#DbOOQP'#Dj'#DjO(zQaO'#CmO)YQgO'#CmOOQP'#Cm'#CmQ)jQaOOQ)uQgOOQ]QgOOO*PQdO'#CrO*nQdO'#CtOOQO'#Dw'#DwO+]Q`O'#CxO+hQdO'#CwO+rQ`O'#CwOOQO'#Cv'#CvO+wQdO'#CvOOQO'#Cq'#CqO,UQ`O,59[O,^QfO,59[OOQR,59[,59[OOQO'#Cx'#CxO,eQ`O'#DPO,pQdO'#DPOOQO'#Dx'#DxO,zQdO'#DxO-XQ`O,59jO-aQfO,59jOOQR,59j,59jOOQR'#DS'#DSO-hQcO,59mO-sQgO'#DVO.TQ`O'#DVO.YQcO,59pOOQR'#DX'#DXO#|QfO'#DWO.hQcO'#DWOOQR,59v,59vO.yOWO,59vO/OOaO,59vO/WOaO,59vO/cQgO'#D_OOQR,59x,59xO0VQgO'#DaOOQR,59z,59zOOQP,59|,59|O0yOaO,59|O1ROaO,59|O1aOqO,59|OOQP-E7h-E7hO1oQgO,59XOOQP,59X,59XO2PQaO'#DeO2_QgO'#DeO2oQgO'#DkOOQP'#Dk'#DkQ)jQaOOO3PQdO'#CsOOQO,59^,59^O3kQdO'#CuOOQO,59`,59`OOQO,59c,59cO4VQdO,59cO4aQdO'#CzO4kQ`O'#CzOOQO,59b,59bOOQU,5:Q,5:QOOQR1G.v1G.vO4pQ`O1G.vOOQU-E7d-E7dO4xQdO,59kOOQO,59k,59kO5SQdO'#DQO5^Q`O'#DQOOQO,5:d,5:dOOQU,5:R,5:ROOQR1G/U1G/UO5cQ`O1G/UOOQU-E7e-E7eO5kQgO'#DhO5xQcO1G/XOOQR1G/X1G/XOOQR,59q,59qO6TQgO,59qO6eQdO'#DiO6lQgO'#DiO7PQcO1G/[OOQR1G/[1G/[OOQR,59r,59rO#|QfO,59rOOQR1G/b1G/bO7_OWO1G/bO7dOaO1G/bOOQR,59y,59yOOQR,59{,59{OOQP1G/h1G/hO7lOaO1G/hO7tOaO1G/hO8POaO1G/hOOQP1G.s1G.sO8_QgO,5:POOQP,5:P,5:POOQP,5:V,5:VOOQP-E7i-E7iOOQO,59_,59_OOQO,59a,59aOOQO1G.}1G.}OOQO,59f,59fO8oQdO,59fOOQR7+$b7+$bP,XQ`O'#DfOOQO1G/V1G/VOOQO,59l,59lO8yQdO,59lOOQR7+$p7+$pP9TQ`O'#DgOOQR'#DT'#DTOOQR,5:S,5:SOOQR-E7f-E7fOOQR7+$s7+$sOOQR1G/]1G/]O9YQgO'#DYO9jQ`O'#DYOOQR,5:T,5:TO#|QfO'#DZO9oQcO'#DZOOQR-E7g-E7gOOQR7+$v7+$vOOQR1G/^1G/^OOQR7+$|7+$|O:QOWO7+$|OOQP7+%S7+%SO:VOaO7+%SO:_OaO7+%SOOQP1G/k1G/kOOQO1G/Q1G/QOOQO1G/W1G/WOOQR,59t,59tO:jQgO,59tOOQR,59u,59uO#|QfO,59uOOQR<<Hh<<HhOOQP<<Hn<<HnO:zOaO<<HnOOQR1G/`1G/`OOQR1G/a1G/aOOQPAN>YAN>Y",stateData:";S~O!fOS!gOS^OS~OP_OQbORSOTUOWROXROYYOZZO[XOcPOqQO!PVO!V[O!cTO~O`cO~P]OVkOWROXROYeOZfO[dOcPOmhOqQO~OboO~P!bOVtOWROXROYeOZfO[dOcPOmrOqQO~OpwO~P#WORSOTUOWROXROYYOZZO[XOcPOqQO!PVO!cTO~OSvP!avP!bvP~P#|OWROXROYeOZfO[dOcPOqQO~OmzO~P%OOm!OOUzP!azP!bzP!dzP~P#|O^!SO!b!QO!f!TO!g!RO~ORSOTUOWROXROcPOqQO!PVO!cTO~OY!UOP!QXQ!QX!V!QX!`!QXS!QX!a!QX!b!QXU!QXm!QX!d!QX~P&aO[!WOP!SXQ!SX!V!SX!`!SXS!SX!a!SX!b!SXU!SXm!SX!d!SX~P&aO^!ZO!W![O!b!YO!f!]O!g!YO~OP!_O!V[OQaX!`aX~OPaXQaX!VaX!`aX~P#|OP!bOQ!cO!V[O~OP_O!V[O~P#|OWROXROY!fOcPOqQObfXmfXofXpfX~OWROXRO[!hOcPOqQObhXmhXohXphX~ObeXmlXoeX~ObkXokX~P%OOm!kO~Om!lObnPonP~P%OOb!pOo!oO~Ob!pO~P!bOm!sOosXpsX~OosXpsX~P%OOm!uOotPptP~P%OOo!xOp!yO~Op!yO~P#WOS!|O!a#OO!b#OO~OUyX!ayX!byX!dyX~P#|Om#QO~OU#SO!a#UO!b#UO!d#RO~Om#WOUzX!azX!bzX!dzX~O]#XO~O!b#XO!g#YO~O^#ZO!b#XO!g#YO~OP!RXQ!RX!V!RX!`!RXS!RX!a!RX!b!RXU!RXm!RX!d!RX~P&aOP!TXQ!TX!V!TX!`!TXS!TX!a!TX!b!TXU!TXm!TX!d!TX~P&aO!b#^O!g#^O~O^#_O!b#^O!f#`O!g#^O~O^#_O!W#aO!b#^O!g#^O~OPaaQaa!Vaa!`aa~P#|OP#cO!V[OQ!XX!`!XX~OP!XXQ!XX!V!XX!`!XX~P#|OP_O!V[OQ!_X!`!_X~P#|OWROXROcPOqQObgXmgXogXpgX~OWROXROcPOqQObiXmiXoiXpiX~Obkaoka~P%OObnXonX~P%OOm#kO~Ob#lOo!oO~Oosapsa~P%OOotXptX~P%OOm#pO~Oo!xOp#qO~OSwP!awP!bwP~P#|OS!|O!a#vO!b#vO~OUya!aya!bya!dya~P#|Om#xO~P%OOm#{OU}P!a}P!b}P!d}P~P#|OU#SO!a$OO!b$OO!d#RO~O]$QO~O!b$QO!g$RO~O!b$SO!g$SO~O^$TO!b$SO!g$SO~O^$TO!b$SO!f$UO!g$SO~OP!XaQ!Xa!V!Xa!`!Xa~P#|Obnaona~P%OOotapta~P%OOo!xO~OU|X!a|X!b|X!d|X~P#|Om$ZO~Om$]OU}X!a}X!b}X!d}X~O]$^O~O!b$_O!g$_O~O^$`O!b$_O!g$_O~OU|a!a|a!b|a!d|a~P#|O!b$cO!g$cO~O",goto:",]!mPPPPPPPPPPPPPPPPP!nPP!v#v#|$`#|$c$f$j$nP%VPPP!v%Y%^%a%{&O%a&R&U&X&_&b%aP&e&{&e'O'RPP']'a'g'm's'y(XPPPPPPPP(_)e*X+c,VUaObcR#e!c!{ROPQSTUXY_bcdehknrtvz!O!U!W!_!b!c!f!h!k!l!s!u!|#Q#R#S#W#c#k#p#x#{$Z$]QmPR!qnqfPQThknrtv!k!l!s!u#R#k#pR!gdR!ieTlPnTjPnSiPnSqQvQ{TQ!mkQ!trQ!vtR#y#RR!nkTsQvR!wt!RWOSUXY_bcz!O!U!W!_!b!c!|#Q#S#W#c#x#{$Z$]RySR#t!|R|TR|UQ!PUR#|#SR#z#RR#z#SyZOSU_bcz!O!_!b!c!|#Q#S#W#c#x#{$Z$]R!VXR!XYa]O^abc!a!c!eT!da!eQnPR!rnQvQR!{vQ!}yR#u!}Q#T|R#}#TW^Obc!cS!^^!aT!aa!eQ!eaR#f!eW`Obc!cQxSS}U#SQ!`_Q#PzQ#V!OQ#b!_Q#d!bQ#s!|Q#w#QQ$P#WQ$V#cQ$Y#xQ$[#{Q$a$ZR$b$]xZOSU_bcz!O!_!b!c!|#Q#S#W#c#x#{$Z$]Q!VXQ!XYQ#[!UR#]!W!QWOSUXY_bcz!O!U!W!_!b!c!|#Q#S#W#c#x#{$Z$]pfPQThknrtv!k!l!s!u#R#k#pQ!gdQ!ieQ#g!fR#h!hSgPn^pQTkrtv#RQ!jhQ#i!kQ#j!lQ#n!sQ#o!uQ$W#kR$X#pQuQR!zv",nodeNames:"\u26A0 DirectiveEnd DocEnd - - ? ? ? Literal QuotedLiteral Anchor Alias Tag BlockLiteralContent Comment Stream BOM Document ] [ FlowSequence Item Tagged Anchored Anchored Tagged FlowMapping Pair Key : Pair , } { FlowMapping Pair Pair BlockSequence Item Item BlockMapping Pair Pair Key Pair Pair BlockLiteral BlockLiteralHeader Tagged Anchored Anchored Tagged Directive DirectiveName DirectiveContent Document",maxTerm:74,context:qt,nodeProps:[["isolate",-3,8,9,14,""],["openedBy",18,"[",32,"{"],["closedBy",19,"]",33,"}"]],propSources:[es],skippedNodes:[0],repeatNodeCount:6,tokenData:"-Y~RnOX#PXY$QYZ$]Z]#P]^$]^p#Ppq$Qqs#Pst$btu#Puv$yv|#P|}&e}![#P![!]'O!]!`#P!`!a'i!a!}#P!}#O*g#O#P#P#P#Q+Q#Q#o#P#o#p+k#p#q'i#q#r,U#r;'S#P;'S;=`#z<%l?HT#P?HT?HU,o?HUO#PQ#UU!WQOY#PZp#Ppq#hq;'S#P;'S;=`#z<%lO#PQ#kTOY#PZs#Pt;'S#P;'S;=`#z<%lO#PQ#}P;=`<%l#P~$VQ!f~XY$Qpq$Q~$bO!g~~$gS^~OY$bZ;'S$b;'S;=`$s<%lO$b~$vP;=`<%l$bR%OX!WQOX%kXY#PZ]%k]^#P^p%kpq#hq;'S%k;'S;=`&_<%lO%kR%rX!WQ!VPOX%kXY#PZ]%k]^#P^p%kpq#hq;'S%k;'S;=`&_<%lO%kR&bP;=`<%l%kR&lUoP!WQOY#PZp#Ppq#hq;'S#P;'S;=`#z<%lO#PR'VUmP!WQOY#PZp#Ppq#hq;'S#P;'S;=`#z<%lO#PR'p[!PP!WQOY#PZp#Ppq#hq{#P{|(f|}#P}!O(f!O!R#P!R![)p![;'S#P;'S;=`#z<%lO#PR(mW!PP!WQOY#PZp#Ppq#hq!R#P!R![)V![;'S#P;'S;=`#z<%lO#PR)^U!PP!WQOY#PZp#Ppq#hq;'S#P;'S;=`#z<%lO#PR)wY!PP!WQOY#PZp#Ppq#hq{#P{|)V|}#P}!O)V!O;'S#P;'S;=`#z<%lO#PR*nUcP!WQOY#PZp#Ppq#hq;'S#P;'S;=`#z<%lO#PR+XUbP!WQOY#PZp#Ppq#hq;'S#P;'S;=`#z<%lO#PR+rUqP!WQOY#PZp#Ppq#hq;'S#P;'S;=`#z<%lO#PR,]UpP!WQOY#PZp#Ppq#hq;'S#P;'S;=`#z<%lO#PR,vU`P!WQOY#PZp#Ppq#hq;'S#P;'S;=`#z<%lO#P",tokenizers:[Ht,jt,Kt,Jt,0,1],topRules:{Stream:[0,15]},tokenPrec:0});var _=require("@codemirror/language"),ts=require("@lezer/common"),de=require("@lezer/highlight"),it=require("@lezer/lr"),ss=it.LRParser.deserialize({version:14,states:"!vOQOPOOO]OPO'#C_OhOPO'#C^OOOO'#Cc'#CcOpOPO'#CaQOOOOOO{OPOOOOOO'#Cb'#CbO!WOPO'#C`O!`OPO,58xOOOO-E6a-E6aOOOO-E6`-E6`OOOO'#C_'#C_OOOO1G.d1G.d",stateData:"!h~OXPOYROWTP~OWVXXRXYRX~OYVOXSP~OXROYROWTX~OXROYROWTP~OYVOXSX~OX[O~OXY~",goto:"vWPPX[beioRUOQQOR]XRXQTTOUQWQRZWSSOURYS",nodeNames:"\u26A0 Document Frontmatter DashLine FrontmatterContent Body",maxTerm:10,skippedNodes:[0],repeatNodeCount:2,tokenData:"$z~RXOYnYZ!^Z]n]^!^^}n}!O!i!O;'Sn;'S;=`!c<%lOn~qXOYnYZ!^Z]n]^!^^;'Sn;'S;=`!c<%l~n~On~~!^~!cOY~~!fP;=`<%ln~!lZOYnYZ!^Z]n]^!^^}n}!O#_!O;'Sn;'S;=`!c<%l~n~On~~!^~#bZOYnYZ!^Z]n]^!^^}n}!O$T!O;'Sn;'S;=`!c<%l~n~On~~!^~$WXOYnYZ$sZ]n]^$s^;'Sn;'S;=`!c<%l~n~On~~$s~$zOX~Y~",tokenizers:[0],topRules:{Document:[0,1]},tokenPrec:67}),rs=_.LRLanguage.define({name:"yaml",parser:at.configure({props:[_.indentNodeProp.add({Stream:a=>{for(let n=a.node.resolve(a.pos,-1);n&&n.to>=a.pos;n=n.parent){if(n.name=="BlockLiteralContent"&&n.from<n.to)return a.baseIndentFor(n);if(n.name=="BlockLiteral")return a.baseIndentFor(n)+a.unit;if(n.name=="BlockSequence"||n.name=="BlockMapping")return a.column(n.from,1);if(n.name=="QuotedLiteral")return null;if(n.name=="Literal"){let e=a.column(n.from,1);if(e==a.lineIndent(n.from,1))return e;if(n.to>a.pos)return null}}return null},FlowMapping:(0,_.delimitedIndent)({closing:"}"}),FlowSequence:(0,_.delimitedIndent)({closing:"]"})}),_.foldNodeProp.add({"FlowMapping FlowSequence":_.foldInside,"Item Pair BlockLiteral":(a,n)=>({from:n.doc.lineAt(a.from).to,to:a.to})})]}),languageData:{commentTokens:{line:"#"},indentOnInput:/^\s*[\]\}]$/}});function ot(){return new _.LanguageSupport(rs)}var Ts=_.LRLanguage.define({name:"yaml-frontmatter",parser:ss.configure({props:[(0,de.styleTags)({DashLine:de.tags.meta})]})});var B="arete-yaml-editor",ct=pe.Annotation.define();var he=class extends x.ItemView{constructor(e,t){super(e);this.editorView=null;this.indexContainer=null;this.editorContainer=null;this.fieldEditorContainer=null;this.previewContainer=null;this.toolbarContainer=null;this.currentCardIndex=0;this.cards=[];this.currentFilePath=null;this.isUpdatingFromMain=!1;this.viewMode="fields";this.syncDebounceTimer=null;this.plugin=t}getViewType(){return"arete-yaml-editor"}getDisplayText(){return"Card Editor"}getIcon(){return"file-code"}async onOpen(){var s;let e=this.containerEl.children[1];e.empty(),e.addClass("arete-yaml-editor-container"),this.indexContainer=e.createDiv({cls:"arete-yaml-index"});let t=e.createDiv({cls:"arete-yaml-editor-panel"});this.toolbarContainer=t.createDiv({cls:"arete-editor-toolbar"}),this.editorContainer=t.createDiv({cls:"arete-yaml-editor-wrapper"}),this.editorContainer.style.flex="1",this.editorContainer.style.overflow="hidden",this.fieldEditorContainer=t.createDiv({cls:"arete-field-editor"}),this.fieldEditorContainer.hide(),this.previewContainer=t.createDiv({cls:"arete-preview-container"}),this.previewContainer.hide(),await this.loadCards(),this.renderIndex(),this.renderToolbar(),this.createEditor(),this.setViewMode(this.viewMode),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.handleActiveFileChange()})),this.registerEvent(this.app.vault.on("modify",r=>{let i=this.app.workspace.getActiveFile();i&&i.path===r.path&&!this.isUpdatingFromMain&&this.syncFromMain()})),(s=this.indexContainer)==null||s.addEventListener("keydown",r=>this.handleKeyNavigation(r))}async onClose(){this.editorView&&(this.editorView.destroy(),this.editorView=null),this.syncDebounceTimer&&clearTimeout(this.syncDebounceTimer)}async loadCards(){var s;let e=this.app.workspace.getActiveFile();if(!e){this.cards=[],this.currentFilePath=null;return}this.currentFilePath!==e.path&&(this.currentCardIndex=0,this.currentFilePath=e.path);let t=this.app.metadataCache.getFileCache(e);(s=t==null?void 0:t.frontmatter)!=null&&s.cards&&Array.isArray(t.frontmatter.cards)?this.cards=t.frontmatter.cards:this.cards=[],this.currentCardIndex>=this.cards.length&&(this.currentCardIndex=Math.max(0,this.cards.length-1))}handleActiveFileChange(){this.loadCards().then(()=>{this.renderIndex(),this.refreshActiveView()})}refreshActiveView(){this.renderToolbar(),this.viewMode==="source"?this.updateEditorContent():this.viewMode==="fields"?this.renderFieldEditor():this.viewMode==="preview"&&this.renderPreview()}renderIndex(){if(!this.indexContainer)return;this.indexContainer.empty(),this.indexContainer.createDiv({cls:"arete-yaml-index-header"}).createSpan({text:`${this.cards.length}`,cls:"arete-yaml-index-count"});let t=this.indexContainer.createDiv({cls:"arete-yaml-index-list"});t.setAttribute("tabindex","0"),this.cards.forEach((r,i)=>{let o=t.createDiv({cls:"arete-yaml-index-item",attr:{"data-index":String(i),draggable:"true"}});if(this.getCardWarning(i)){o.addClass("has-warning");let c=o.createSpan({cls:"arete-yaml-index-warning"});(0,x.setIcon)(c,"alert-triangle")}o.createSpan({text:`${i+1}`,cls:"arete-yaml-index-number"}),i===this.currentCardIndex&&o.addClass("is-active");let d=r.front||r.Front||"";d&&o.setAttribute("title",d.substring(0,50)+(d.length>50?"...":"")),o.addEventListener("click",()=>{this.selectCard(i,!0)}),o.addEventListener("contextmenu",c=>this.showCardContextMenu(c,i)),o.addEventListener("dragstart",c=>this.handleDragStart(c,i)),o.addEventListener("dragover",c=>this.handleDragOver(c)),o.addEventListener("drop",c=>this.handleDrop(c,i)),o.addEventListener("dragend",()=>this.handleDragEnd())});let s=this.indexContainer.createDiv({cls:"arete-yaml-index-add"});(0,x.setIcon)(s,"plus"),s.addEventListener("click",()=>this.addCard())}handleKeyNavigation(e){e.key==="ArrowDown"?(e.preventDefault(),this.selectCard(Math.min(this.cards.length-1,this.currentCardIndex+1),!0)):e.key==="ArrowUp"&&(e.preventDefault(),this.selectCard(Math.max(0,this.currentCardIndex-1),!0))}handleDragStart(e,t){e.dataTransfer&&(e.dataTransfer.setData("text/plain",String(t)),e.dataTransfer.effectAllowed="move"),e.target.addClass("is-dragging")}handleDragOver(e){e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move");let t=e.target.closest(".arete-yaml-index-item");t&&t.addClass("drag-over")}handleDragEnd(){var t;let e=(t=this.indexContainer)==null?void 0:t.querySelectorAll(".arete-yaml-index-item");e==null||e.forEach(s=>{s.removeClass("is-dragging"),s.removeClass("drag-over")})}async handleDrop(e,t){var r;e.preventDefault();let s=Number((r=e.dataTransfer)==null?void 0:r.getData("text/plain"));isNaN(s)||s===t||await this.reorderCards(s,t)}showCardContextMenu(e,t){let s=new x.Menu;s.addItem(r=>{r.setTitle("Delete Card").setIcon("trash").setWarning(!0).onClick(()=>this.deleteCard(t))}),s.showAtMouseEvent(e)}renderToolbar(){if(!this.toolbarContainer)return;this.toolbarContainer.empty();let e=this.toolbarContainer.createDiv({cls:"arete-toolbar-group"}),t=this.app.workspace.getActiveFile(),s=this.cards[this.currentCardIndex],r=s==null?void 0:s.nid;if(t&&r){let u=this.plugin.statsService.getCache().concepts[t.path];if(u&&u.cardStats&&u.cardStats[r]){let f=u.cardStats[r],g=e.createDiv({cls:"arete-toolbar-stats"}),m=this.plugin.settings.stats_algorithm,y=!1;if(m==="fsrs"&&f.difficulty!==void 0){if(f.difficulty!==null){let v="arete-stat-badge";f.difficulty>8?v+=" mod-warning":f.difficulty>5?v+=" mod-orange":v+=" mod-success",g.createDiv({cls:v,text:`D: ${Math.round(f.difficulty*10)}%`,attr:{title:`FSRS Difficulty: ${Math.round(f.difficulty*10)}%`}})}else g.createDiv({cls:"arete-stat-badge mod-muted",text:"D: ?",attr:{title:"FSRS Difficulty not available"}});y=!0}else if(m==="sm2"||f.ease!==void 0){let v=Math.round(f.ease/10);g.createDiv({cls:"arete-stat-badge",text:`E: ${v}%`,attr:{title:`SM-2 Ease: ${v}%`}}),y=!0}if(f.lapses>0){let v="arete-stat-badge";f.lapses>5?v+=" mod-warning":v+=" mod-orange",g.createDiv({cls:v,text:`${f.lapses}L`,attr:{title:`Lapses: ${f.lapses}`}}),y=!0}if(f.due){let v=new Date(f.due*1e3),w=new Date,k=Math.ceil((v.getTime()-w.getTime())/(1e3*60*60*24)),b="";k<0?b=`${Math.abs(k)}d ago`:k===0?b="Today":b=`${k}d`,g.createDiv({cls:"arete-stat-badge mod-muted",text:b,attr:{title:`Due: ${v.toLocaleDateString()}`}}),y=!0}y||g.createDiv({cls:"arete-stat-badge mod-muted",text:"No Data"})}else e.createDiv({cls:"arete-stat-badge mod-muted",text:"No Stats"})}let i=this.toolbarContainer.createDiv({cls:"arete-toolbar-group"}),o=i.createDiv({cls:"arete-toolbar-btn",attr:{title:"Go to YAML in Note"}});(0,x.setIcon)(o,"file-text"),o.addEventListener("click",()=>this.scrollToCard(this.currentCardIndex));let l=i.createDiv({cls:"arete-toolbar-btn",attr:{title:"Open in Anki"}});(0,x.setIcon)(l,"external-link"),l.addEventListener("click",()=>this.openInAnki(this.currentCardIndex));let d=this.toolbarContainer.createDiv({cls:"arete-toolbar-group"}),c=d.createDiv({cls:"arete-toolbar-btn"+(this.viewMode==="fields"?" is-active":""),attr:{title:"Card Edit Mode"}});(0,x.setIcon)(c,"edit-3"),c.addEventListener("click",()=>this.setViewMode("fields"));let h=d.createDiv({cls:"arete-toolbar-btn"+(this.viewMode==="source"?" is-active":""),attr:{title:"Source Mode"}});(0,x.setIcon)(h,"code"),h.addEventListener("click",()=>this.setViewMode("source"));let p=d.createDiv({cls:"arete-toolbar-btn"+(this.viewMode==="preview"?" is-active":""),attr:{title:"Preview Mode"}});(0,x.setIcon)(p,"eye"),p.addEventListener("click",()=>this.setViewMode("preview"))}setViewMode(e){var t,s,r,i,o,l;this.viewMode=e,this.renderToolbar(),(t=this.editorContainer)==null||t.hide(),(s=this.fieldEditorContainer)==null||s.hide(),(r=this.previewContainer)==null||r.hide(),e==="source"?((i=this.editorContainer)==null||i.show(),this.updateEditorContent()):e==="fields"?((o=this.fieldEditorContainer)==null||o.show(),this.renderFieldEditor()):e==="preview"&&((l=this.previewContainer)==null||l.show(),this.renderPreview())}renderFieldEditor(){if(!this.fieldEditorContainer)return;this.fieldEditorContainer.empty();let e=this.cards[this.currentCardIndex];if(!e)return;let t=e.model||e.Model||"Basic";this.fieldEditorContainer.createDiv({cls:"arete-field-model-badge",text:t}),Object.entries(e).forEach(([s,r])=>{var d;if(["model","Model","nid","NID","cid","CID"].includes(s))return;let i=(d=this.fieldEditorContainer)==null?void 0:d.createDiv({cls:"arete-field-group"});i==null||i.createEl("label",{cls:"arete-field-label",text:s});let o=i==null?void 0:i.createEl("textarea",{cls:"arete-field-input",text:String(r)}),l=c=>{c.style.height="auto",c.style.height=c.scrollHeight+2+"px"};requestAnimationFrame(()=>l(o)),o==null||o.addEventListener("input",()=>{l(o),e[s]=o.value,this.debouncedSyncToMain()})})}async renderPreview(){if(!this.previewContainer)return;this.previewContainer.empty();let e=this.cards[this.currentCardIndex];e&&Object.entries(e).forEach(async([t,s])=>{var o;if(["model","Model","nid","NID","cid","CID"].includes(t))return;let r=(o=this.previewContainer)==null?void 0:o.createDiv({cls:"arete-preview-section"});r==null||r.createDiv({cls:"arete-preview-label",text:t});let i=r==null?void 0:r.createDiv({cls:"arete-preview-content"});i&&typeof s=="string"&&await x.MarkdownRenderer.render(this.app,s,i,this.currentFilePath||"",this)})}createEditor(){if(!this.editorContainer)return;this.editorContainer.empty();let e=this.extractCardYaml(this.currentCardIndex),t=pe.EditorState.create({doc:e,extensions:[ot(),(0,V.lineNumbers)(),(0,G.history)(),V.keymap.of([...G.defaultKeymap,...G.historyKeymap]),V.EditorView.lineWrapping,V.EditorView.updateListener.of(s=>{s.docChanged&&(s.transactions.some(i=>i.annotation(ct))||this.debouncedSyncToMain())}),V.EditorView.theme({"&":{height:"100%"},".cm-scroller":{overflow:"auto"}})]});this.editorView=new V.EditorView({state:t,parent:this.editorContainer})}updateEditorContent(){if(!this.editorView)return;let e=this.extractCardYaml(this.currentCardIndex);this.editorView.dispatch({changes:{from:0,to:this.editorView.state.doc.length,insert:e},annotations:ct.of(!0)})}extractCardYaml(e){if(e<0||e>=this.cards.length)return`# No card selected
`;let t=this.cards[e];return Object.entries(t).map(([s,r])=>{let i=["front","back","text","extra","Front","Back","Text","Extra"].includes(s);if(typeof r=="string"){let o=/['":#]/.test(r);if(r.includes(`
`)||i||o)return r?`${s}: |-
  ${r.replace(/\n/g,`
  `)}`:`${s}: ''`}return`${s}: ${r}`}).join(`
`)}parseYamlToCard(e){let t={},s=e.split(`
`),r=null,i=[],o=()=>{r&&(t[r]=i.join(`
`).trim())};return s.forEach(l=>{let d=l.match(/^(\w+):\s*(.*)/);if(d){o(),r=d[1];let c=d[2].trim();c==="|"||c==="|-"||c==="|+"?i=[]:(t[r]=c,r=null)}else r&&l.startsWith("  ")&&i.push(l.substring(2))}),o(),t}debouncedSyncToMain(){this.syncDebounceTimer&&clearTimeout(this.syncDebounceTimer),this.syncDebounceTimer=setTimeout(()=>this.syncToMain(),300)}async syncToMain(){if(!this.editorView)return;let e=this.app.workspace.getActiveFile();if(!e)return;let t="";this.viewMode==="source"?t=this.editorView.state.doc.toString():t=this.extractCardYaml(this.currentCardIndex);let s=this.parseYamlToCard(t);this.isUpdatingFromMain=!0;try{await this.app.fileManager.processFrontMatter(e,r=>{r.cards&&r.cards[this.currentCardIndex]&&(r.cards[this.currentCardIndex]=s)})}finally{setTimeout(()=>{this.isUpdatingFromMain=!1},100)}}async syncFromMain(){await this.loadCards(),this.renderIndex(),this.refreshActiveView()}async scrollToCard(e){let t=this.app.workspace.getMostRecentLeaf();if(t&&t.view instanceof x.MarkdownView){let s=t.view.editor,i=s.getValue().split(`
`),o=0,l=-1;for(let d=0;d<i.length;d++)if(i[d].includes("cards:")){for(let c=d+1;c<i.length;c++)if(i[c].trim().startsWith("-")){if(o===e){l=c;break}o++}break}l!==-1&&(s.setCursor({line:l,ch:0}),s.scrollIntoView({from:{line:l,ch:0},to:{line:l,ch:0}},!0))}}async openInAnki(e){let t=this.cards[e],s=t==null?void 0:t.nid;if(s)try{await this.plugin.areteClient.browse(`nid:${s}`)||new x.Notice("Failed to open Anki browser.")}catch(r){new x.Notice("Failed to open Anki browser. Check if the server/CLI is accessible.")}else new x.Notice("Card is not yet synced to Anki (no NID found).")}getCardWarning(e){let t=this.app.workspace.getActiveFile();if(!t)return!1;let s=this.plugin.statsService.getCache().concepts[t.path];if(!s||!s.problematicCards)return!1;let r=this.cards[e],i=r==null?void 0:r.nid;return i?s.problematicCards.some(o=>o.noteId===i):!1}selectCard(e,t=!1){if(!(e<0||e>=this.cards.length)){if(this.indexContainer){let s=this.indexContainer.querySelector(`.arete-yaml-index-item[data-index="${this.currentCardIndex}"]`);s&&s.removeClass("is-active");let r=this.indexContainer.querySelector(`.arete-yaml-index-item[data-index="${e}"]`);if(r&&(r.addClass("is-active"),t)){let i=this.indexContainer.querySelector(".arete-yaml-index-list");i&&i.focus(),r.scrollIntoView({block:"nearest"})}}this.currentCardIndex=e,this.refreshActiveView(),this.plugin.highlightCardLines(e)}}focusCard(e){e>=0&&e<this.cards.length&&(this.currentCardIndex=e,this.renderIndex(),this.refreshActiveView())}async addCard(){let e=this.app.workspace.getActiveFile();e&&(await this.app.fileManager.processFrontMatter(e,t=>{t.cards||(t.cards=[]),t.cards.push({front:"",back:""})}),await this.loadCards(),this.currentCardIndex=this.cards.length-1,this.renderIndex(),this.refreshActiveView())}async deleteCard(e){let t=this.app.workspace.getActiveFile();t&&(await this.app.fileManager.processFrontMatter(t,s=>{s.cards&&s.cards.splice(e,1)}),await this.loadCards(),this.currentCardIndex>=this.cards.length&&(this.currentCardIndex=Math.max(0,this.cards.length-1)),this.renderIndex(),this.refreshActiveView())}async reorderCards(e,t){let s=this.app.workspace.getActiveFile();s&&(await this.app.fileManager.processFrontMatter(s,r=>{if(r.cards){let[i]=r.cards.splice(e,1);r.cards.splice(t,0,i)}}),this.currentCardIndex===e?this.currentCardIndex=t:e<this.currentCardIndex&&t>=this.currentCardIndex?this.currentCardIndex--:e>this.currentCardIndex&&t<=this.currentCardIndex&&this.currentCardIndex++,await this.loadCards(),this.renderIndex(),this.refreshActiveView())}};var S=require("obsidian"),z="arete-stats-view",ue=class extends S.ItemView{constructor(e,t){super(e);this.activeTab="overview";this.overviewMode="hierarchy";this.brokenRefs=null;this.isScanning=!1;this.plugin=t,this.expandedDecks=new Set(this.plugin.settings.ui_expanded_decks||[]),this.expandedConcepts=new Set(this.plugin.settings.ui_expanded_concepts||[])}getViewType(){return z}getDisplayText(){return"Arete Dashboard"}getIcon(){return"layout-dashboard"}async onOpen(){this.render()}async render(){let e=this.containerEl.children[1];e.empty(),e.addClass("arete-dashboard-container"),e.style.display="flex",e.style.flexDirection="column",e.style.height="100%",e.style.overflow="hidden",this.renderHeader(e),this.renderTabs(e);let t=e.createDiv({cls:"arete-dashboard-content"});switch(t.style.flex="1",t.style.overflowY="auto",t.style.padding="1rem",this.activeTab){case"overview":this.renderOverview(t);break;case"leeches":await this.renderLeeches(t);break;case"integrity":this.renderIntegrity(t);break}}renderHeader(e){let t=e.createDiv({cls:"arete-dashboard-header"});t.style.padding="1rem",t.style.borderBottom="1px solid var(--background-modifier-border)",t.style.display="flex",t.style.justifyContent="space-between",t.style.alignItems="center",t.style.background="var(--background-secondary)";let s=t.createEl("h3",{text:"Arete Dashboard"});s.style.margin="0 auto 0 0";let r=this.plugin.statsService.getCache(),i=0,o=0;Object.values(r.concepts).forEach(h=>{i+=h.totalCards,o+=h.problematicCardsCount});let l=t.createDiv({cls:"arete-header-stats"});l.style.display="flex",l.style.gap="1rem",l.style.fontSize="0.9em",l.style.color="var(--text-muted)",l.createSpan({text:`${i} Cards`});let d=l.createSpan({text:`${o} Issues`});o>0&&(d.style.color="var(--color-red)");let c=t.createEl("button",{cls:"arete-icon-btn"});(0,S.setIcon)(c,"refresh-cw"),c.title="Sync & Refresh Stats",c.onclick=async()=>{c.addClass("arete-spin"),await this.plugin.statsService.refreshStats(),await this.plugin.saveStats(),this.render(),c.removeClass("arete-spin")}}renderTabs(e){let t=e.createDiv({cls:"arete-tab-bar"});t.style.display="flex",t.style.gap="2px",t.style.padding="0 1rem",t.style.background="var(--background-secondary)",t.style.borderBottom="1px solid var(--background-modifier-border)",[{id:"overview",label:"Overview",icon:"bar-chart-2"},{id:"leeches",label:"Leeches",icon:"flame"},{id:"integrity",label:"Integrity",icon:"link"}].forEach(r=>{let i=t.createDiv({cls:"arete-tab-btn"});i.style.padding="8px 16px",i.style.cursor="pointer",i.style.borderBottom="2px solid transparent",i.style.display="flex",i.style.gap="6px",i.style.alignItems="center",i.style.fontSize="0.9em",i.style.fontWeight="500",i.style.color="var(--text-muted)",this.activeTab===r.id&&(i.style.borderBottomColor="var(--interactive-accent)",i.style.color="var(--text-normal)",i.addClass("is-active"));let o=i.createSpan();(0,S.setIcon)(o,r.icon),i.createSpan({text:r.label}),i.onclick=()=>{this.activeTab=r.id,this.render()}})}renderOverview(e){let t=e.createDiv({cls:"arete-overview-controls"});t.style.display="flex",t.style.justifyContent="flex-end",t.style.marginBottom="1rem",t.style.gap="0.5rem";let s=t.createEl("select"),r=s.createEl("option",{text:"Folder View",value:"hierarchy"}),i=s.createEl("option",{text:"Worst Concepts",value:"leaderboard"});this.overviewMode==="hierarchy"?r.selected=!0:i.selected=!0,s.onchange=()=>{this.overviewMode=s.value,this.render()};let o=Object.values(this.plugin.statsService.getCache().concepts);if(o.length===0){this.renderEmptyState(e,"No statistics available. Please sync.");return}if(this.overviewMode==="hierarchy"){let l=this.buildDeckTree(o);Object.keys(l.children).sort().forEach(c=>{this.renderDeckNode(e,l.children[c],0)}),l.concepts.length>0&&(l.concepts.sort((c,h)=>h.score-c.score),l.concepts.forEach(c=>this.renderConceptRow(e,c)))}else[...o].sort((d,c)=>c.score-d.score).forEach(d=>this.renderConceptRow(e,d))}async renderLeeches(e){let t=this.plugin.leechService.getLeeches(this.plugin.statsService.getCache());if(t.length===0){this.renderEmptyState(e,"No leeches found! Your deck is healthy.");return}let s=e.createEl("table",{cls:"arete-leech-table"});s.style.width="100%",s.style.borderCollapse="collapse";let i=s.createEl("thead").createEl("tr");["Card (Front)","Difficulty","Lapses","Actions"].forEach(l=>{i.createEl("th",{text:l}).style.textAlign="left"});let o=s.createEl("tbody");t.forEach(l=>{let d=o.createEl("tr");d.style.borderBottom="1px solid var(--background-modifier-border)";let c=d.createEl("td");c.style.padding="8px";let h=c.createDiv();h.style.maxWidth="300px",h.style.overflow="hidden",h.style.textOverflow="ellipsis",h.style.whiteSpace="nowrap",h.style.cursor="pointer",h.style.fontWeight="500",h.textContent=l.front.replace(/<[^>]*>?/gm,""),h.title=l.front,h.onclick=()=>this.goToCard(l.filePath,l.front);let p=d.createEl("td");p.textContent=l.ease?`${(l.ease/10).toFixed(0)}% Ease`:l.difficulty!=null?`${(l.difficulty*100).toFixed(0)}% Diff`:"-";let u=d.createEl("td");u.textContent=l.lapses.toString(),l.lapses>10&&(u.style.color="var(--color-red)");let f=d.createEl("td");f.style.display="flex",f.style.gap="0.5rem";let g=f.createEl("button",{text:"Suspend"});g.style.fontSize="0.8em",g.onclick=async()=>{g.textContent="...",await this.plugin.leechService.suspendCard(l.cardId)?(new S.Notice("Card suspended."),d.style.opacity="0.5",g.textContent="Suspended",g.disabled=!0):(new S.Notice("Failed to suspend card."),g.textContent="Suspend")}})}renderIntegrity(e){let t=e.createDiv();t.style.padding="1rem",t.style.background="var(--background-secondary-alt)",t.style.marginBottom="1rem",t.style.borderRadius="8px",t.style.textAlign="center";let s=t.createDiv();s.style.marginBottom="1rem",s.style.color="var(--text-muted)",s.style.fontSize="0.9em",s.innerHTML=`
			<p style="margin-bottom: 0.5rem;">Scans your synced files to find <b>broken image embeds</b> and <b>invalid YAML</b>.</p>
			<p style="margin: 0;">Use this to ensure your Anki cards don't have broken media or syntax errors.</p>
		`;let r=t.createEl("button",{cls:"mod-cta",text:"Run Integrity Check"});if(this.isScanning&&(r.disabled=!0,r.textContent="Scanning Vault..."),r.onclick=async()=>{this.isScanning=!0,this.render();try{let i=this.app.vault.getMarkdownFiles();this.brokenRefs=await this.plugin.linkCheckerService.checkIntegrity(i),new S.Notice(`Integrity check complete. Found ${this.brokenRefs.length} issues.`)}catch(i){console.error(i),new S.Notice("Integrity check failed.")}finally{this.isScanning=!1,this.render()}},this.brokenRefs)if(this.brokenRefs.length===0)this.renderSuccess(e,"No broken links or missing images found!");else{let i=e.createDiv();this.brokenRefs.forEach(o=>{let l=i.createDiv();l.style.padding="0.5rem",l.style.borderBottom="1px solid var(--background-modifier-border)",l.style.display="flex",l.style.justifyContent="space-between",l.style.alignItems="center";let d=l.createDiv(),c=d.createSpan({text:o.sourceFile.basename,cls:"arete-clickable"});c.style.fontWeight="bold",c.onclick=()=>this.app.workspace.getLeaf().openFile(o.sourceFile),d.createSpan({text:" \u2192 "});let h=d.createSpan({text:o.linkPath});h.style.color="var(--color-red)",h.title=`Original text: "${o.linkText}"`;let p=l.createDiv();if(p.style.display="flex",p.style.alignItems="center",p.style.gap="8px",o.type==="invalid-yaml"&&o.errorMessage){let g=p.createSpan({text:o.errorMessage});g.style.fontSize="0.8em",g.style.color="var(--color-red)",g.style.marginRight="8px"}else if(o.type!=="invalid-yaml"&&o.linkText!==`[[${o.linkPath}]]`&&o.linkText!==o.linkPath){let g=p.createSpan({text:`"${o.linkText}"`});g.style.fontSize="0.8em",g.style.color="var(--text-muted)"}let u=p.createSpan({text:o.type.toUpperCase()});u.style.fontSize="0.7em",u.style.padding="2px 4px",u.style.borderRadius="4px",o.type==="invalid-yaml"?(u.style.background="var(--color-red)",u.style.color="var(--text-on-accent)",u.title=o.errorMessage||"Obsidian failed to parse frontmatter. Check for syntax errors."):u.style.background="var(--background-modifier-border)";let f=p.createSpan({cls:"arete-icon-btn"});(0,S.setIcon)(f,"external-link"),f.title="Go to location",f.style.cursor="pointer",f.style.marginLeft="8px",f.onclick=g=>{g.stopPropagation(),this.goToIssue(o.sourceFile,o.linkText)}})}}renderEmptyState(e,t){let s=e.createDiv({cls:"arete-empty-state"});s.style.textAlign="center",s.style.padding="3rem",s.style.color="var(--text-muted)",(0,S.setIcon)(s.createDiv(),"search"),s.createDiv({text:t}).style.marginTop="1rem"}renderSuccess(e,t){let s=e.createDiv();s.style.padding="2rem",s.style.textAlign="center",s.style.color="var(--color-green)",(0,S.setIcon)(s.createDiv(),"check-circle"),s.createDiv({text:t}).style.marginTop="1rem"}buildDeckTree(e){let t={name:"Root",fullName:"",concepts:[],children:{},totalProblematic:0,totalCards:0,totalLapses:0,sumDifficulty:0,countDifficulty:0};return e.forEach(s=>{let i=(s.primaryDeck||"Default").split("::"),o=t,l="";i.forEach(d=>{l=l?`${l}::${d}`:d,o.children[d]||(o.children[d]={name:d,fullName:l,concepts:[],children:{},totalProblematic:0,totalCards:0,totalLapses:0,sumDifficulty:0,countDifficulty:0}),o=o.children[d]}),o.concepts.push(s)}),this.aggregateTree(t),t}aggregateTree(e){e.concepts.forEach(t=>{e.totalProblematic+=t.problematicCardsCount,e.totalCards+=t.totalCards,e.totalLapses+=t.totalLapses,this.plugin.settings.stats_algorithm==="fsrs"&&t.averageDifficulty&&t.difficultyCount&&(e.sumDifficulty+=t.averageDifficulty*t.difficultyCount,e.countDifficulty+=t.difficultyCount)}),Object.values(e.children).forEach(t=>{this.aggregateTree(t),e.totalProblematic+=t.totalProblematic,e.totalCards+=t.totalCards,e.totalLapses+=t.totalLapses,e.sumDifficulty+=t.sumDifficulty,e.countDifficulty+=t.countDifficulty})}renderDeckNode(e,t,s){let r=e.createDiv(),i=r.createDiv();i.style.padding=`8px 16px 8px ${8+s*16}px`,i.style.cursor="pointer",i.style.display="flex",i.style.alignItems="center",i.style.borderBottom="1px solid var(--background-modifier-border)",t.totalProblematic>0&&(i.style.background="rgba(var(--color-red-rgb), 0.05)");let o=i.createSpan();o.style.marginRight="8px";let l=this.expandedDecks.has(t.fullName);(0,S.setIcon)(o,l?"chevron-down":"chevron-right");let d=i.createSpan({text:t.name});d.style.fontWeight="600";let c=i.createDiv({cls:"arete-deck-stats"});c.style.marginLeft="auto",c.style.display="flex",c.style.gap="16px",c.style.fontSize="0.9em",c.style.color="var(--text-muted)";let h=t.countDifficulty?t.sumDifficulty/t.countDifficulty:0;if(h>0){let m=c.createSpan({text:`${(h*100).toFixed(0)}% Diff`});h>.6&&(m.style.color="var(--color-orange)")}let p=t.totalCards>0?t.totalLapses/t.totalCards:0,u=c.createSpan({text:`${p.toFixed(1)} Lap. Avg`});p>2&&(u.style.color="var(--color-red)");let f=c.createSpan({text:`${t.totalProblematic} Issues`,cls:"arete-badge"});t.totalProblematic>0&&(f.style.color="var(--color-red)");let g=r.createDiv();l||(g.style.display="none"),i.onclick=async()=>{this.expandedDecks.has(t.fullName)?this.expandedDecks.delete(t.fullName):this.expandedDecks.add(t.fullName),await this.plugin.saveSettings(),this.render()},l&&(t.concepts.forEach(m=>{let y=g.createDiv();y.style.paddingLeft=`${24+s*16}px`,this.renderConceptRow(y,m)}),Object.values(t.children).forEach(m=>this.renderDeckNode(g,m,s+1)))}renderConceptRow(e,t){let s=e.createDiv();s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.padding="6px 8px",s.style.borderBottom="1px solid var(--background-modifier-border)";let r=s.createDiv();r.style.display="flex",r.style.alignItems="center",r.style.gap="8px",r.style.flex="1";let i=r.createSpan({cls:"arete-icon-btn"});i.style.cursor="pointer",i.title="Show individual cards";let o=this.expandedConcepts.has(t.filePath);(0,S.setIcon)(i,o?"chevron-down":"chevron-right"),i.onclick=async c=>{c.stopPropagation(),o?this.expandedConcepts.delete(t.filePath):this.expandedConcepts.add(t.filePath),await this.plugin.saveSettings(),this.render()};let l=r.createSpan({text:t.fileName,cls:"arete-clickable"});l.style.fontWeight="500",l.onclick=()=>this.openFile(t.filePath);let d=s.createDiv();if(d.style.display="flex",d.style.gap="16px",d.style.fontSize="0.85em",d.style.color="var(--text-muted)",d.style.marginRight="8px",d.createSpan({text:`${t.totalCards} cards`}),this.plugin.settings.stats_algorithm==="fsrs"&&t.averageDifficulty){let c=t.averageDifficulty,h=d.createSpan({text:`${(c*100).toFixed(0)}% Diff`});c>.6&&(h.style.color="var(--color-orange)")}if(t.totalLapses>0){let c=d.createSpan({text:`${t.totalLapses} Lapses`});t.totalLapses>5&&(c.style.color="var(--color-red)")}if(t.problematicCardsCount>0){let c=d.createSpan({text:`${t.problematicCardsCount} Issues`});c.style.color="var(--color-red)",c.style.fontWeight="bold"}if(o){let c=e.createDiv();c.style.background="var(--background-primary-alt)",c.style.borderBottom="1px solid var(--background-modifier-border)";let h=Object.values(t.cardStats);if(h.length===0)c.createDiv({text:"No card stats synced."}).style.padding="8px 32px";else{let p=c.createDiv();p.style.display="flex",p.style.padding="4px 8px 4px 48px",p.style.fontSize="0.75em",p.style.color="var(--text-muted)",p.style.borderBottom="1px solid var(--background-modifier-border)";let u=p.createSpan({text:"Card Question"});u.style.flex="1";let f=p.createSpan({text:"Difficulty"});f.style.width="80px";let g=p.createSpan({text:"Lapses"});g.style.width="60px",h.sort((m,y)=>y.lapses-m.lapses).forEach(m=>{let y=c.createDiv();y.style.display="flex",y.style.alignItems="center",y.style.padding="4px 8px 4px 48px",y.style.fontSize="0.8em",y.style.borderBottom="1px solid var(--background-modifier-border)",y.style.cursor="pointer",y.addEventListener("mouseenter",()=>y.style.backgroundColor="var(--background-modifier-hover)"),y.addEventListener("mouseleave",()=>y.style.backgroundColor="transparent"),y.onclick=$=>{$.stopPropagation(),m.front&&this.goToCard(t.filePath,m.front)};let v=m.front?m.front.replace(/<[^>]*>?/gm,""):`#${m.cardId}`,w=y.createSpan({text:v});w.title=v,w.style.flex="1",w.style.whiteSpace="nowrap",w.style.overflow="hidden",w.style.textOverflow="ellipsis",w.style.marginRight="16px",w.style.fontFamily=m.front?"var(--font-interface)":"monospace";let k=m.difficulty!==void 0?`${(m.difficulty*100).toFixed(0)}%`:m.ease?`${(m.ease/10).toFixed(0)}% Ease`:"-",b=y.createSpan({text:k});b.style.width="80px",b.style.flexShrink="0",m.difficulty&&m.difficulty>.6&&(b.style.color="var(--color-orange)");let D=y.createSpan({text:m.lapses.toString()});D.style.width="60px",D.style.flexShrink="0",m.lapses>5&&(D.style.color="var(--color-red)")})}}}async openFile(e){let t=this.app.vault.getAbstractFileByPath(e);t instanceof S.TFile&&await this.app.workspace.getLeaf().openFile(t)}async goToCard(e,t){await this.openFile(e);let s=this.app.workspace.getActiveViewOfType(S.MarkdownView);if(s){let r=s.editor,i=r.getValue(),o=t.trim().replace(/\s+/g," "),l=i.indexOf(t.split(`
`)[0]);if(l>=0){let d=r.offsetToPos(l);r.setCursor(d),r.scrollIntoView({from:d,to:d},!0)}}}async goToIssue(e,t){await this.app.workspace.getLeaf().openFile(e);let s=this.app.workspace.getActiveViewOfType(S.MarkdownView);if(s){let r=s.editor,i=r.getValue(),o=t.replace(/^Card #\d+: /,""),l=i.indexOf(o);if(l>=0){let d=r.offsetToPos(l);r.setCursor(d),r.scrollIntoView({from:d,to:d},!0),r.setSelection(d,r.offsetToPos(l+o.length))}else new S.Notice(`Could not automatically find text: "${o.substring(0,20)}..."`)}}};var M=require("obsidian"),re="arete-chat-view",fe=class extends M.ItemView{constructor(e,t){super(e);this.messages=[];this.isLoading=!1;this.plugin=t}getViewType(){return re}getDisplayText(){return"Arete AI Assistant"}getIcon(){return"bot"}async onOpen(){this.render()}async onClose(){}async sendMessage(e){if(!(!e.trim()||this.isLoading)){this.messages.push({role:"user",content:e}),this.isLoading=!0,this.render();try{let t=await this.plugin.agentService.chat(e);this.messages.push({role:"assistant",content:t.chat_message,action:t.action_taken||void 0,suggestions:t.suggested_questions})}catch(t){new M.Notice(`Error: ${t.message}`),this.messages.push({role:"assistant",content:`Sorry, I encountered an error: ${t.message}`})}finally{this.isLoading=!1,this.render()}}}render(){let e=this.containerEl.children[1];e.empty(),e.addClass("arete-chat-container");let t=e.createDiv({cls:"arete-chat-messages"});t.addEventListener("click",o=>{let d=o.target.closest(".internal-link");if(d){let c=d.getAttribute("data-href");c&&(o.preventDefault(),this.app.workspace.openLinkText(c,"",!0))}}),this.messages.forEach(o=>{let l=t.createDiv({cls:`arete-chat-message arete-chat-message-${o.role}`});if(o.role==="assistant"){let c=l.createDiv({cls:"arete-chat-message-header"});(0,M.setIcon)(c,"bot"),c.createSpan({text:"Arete"})}let d=l.createDiv({cls:"arete-chat-message-content"});if(M.MarkdownRenderer.render(this.app,o.content,d,"",this),o.action){let c=l.createDiv({cls:"arete-chat-message-action"});c.createSpan({text:"\u2699\uFE0F ",cls:"arete-action-icon"});let h=c.createSpan();M.MarkdownRenderer.render(this.app,o.action,h,"",this)}if(o.role==="assistant"&&o.suggestions&&o.suggestions.length>0){let c=l.createDiv({cls:"arete-chat-suggestions"});o.suggestions.forEach(h=>{let p=c.createEl("button",{cls:"arete-chat-suggestion-btn",text:h});p.onclick=()=>this.sendMessage(h)})}}),this.isLoading&&t.createDiv({cls:"arete-chat-loading"}).createSpan({text:"Thinking..."}),setTimeout(()=>{t.scrollTop=t.scrollHeight},10);let s=e.createDiv({cls:"arete-chat-input-wrapper"}),r=s.createEl("textarea",{cls:"arete-chat-input",attr:{placeholder:"Ask me anything about your learning..."}});r.onkeydown=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),this.sendMessage(r.value),r.value="")};let i=s.createEl("button",{cls:"arete-chat-send-btn"});(0,M.setIcon)(i,"send"),i.onclick=()=>{this.sendMessage(r.value),r.value=""}}};var O=require("obsidian");var lt=require("obsidian"),dt=q(require("path")),Z=class extends lt.Modal{constructor(e,t,s,r){super(e);this.plugin=t,this.result=s,this.filePath=r}onOpen(){let{contentEl:e}=this;e.addClass("arete-modal");let t=e.createDiv({cls:"modal-header"});if(t.createEl("h2",{text:"Arete File Check"}),t.createEl("span",{text:dt.basename(this.filePath),cls:"arete-filename"}),this.result.ok){e.createDiv({text:"\u2705 Valid",cls:"arete-success"});let s=e.createEl("ul",{cls:"arete-stats"}),r=s.createEl("li");r.createSpan({text:"Deck",cls:"arete-stats-label"}),r.createSpan({text:this.result.stats.deck||"None",cls:"arete-stats-val"});let i=s.createEl("li");i.createSpan({text:"Cards Found",cls:"arete-stats-label"}),i.createSpan({text:this.result.stats.cards_found.toString(),cls:"arete-stats-val"})}else{e.createDiv({text:"\u274C Validation Failed",cls:"arete-error"});let s=e.createEl("table",{cls:"arete-error-table"}),i=s.createEl("thead").createEl("tr");i.createEl("th",{text:"Line"}),i.createEl("th",{text:"Error Message"});let o=s.createEl("tbody"),l=!1;if(this.result.errors.forEach(d=>{let c=o.createEl("tr");c.createEl("td",{text:d.line.toString(),cls:"arete-error-line"}),c.createEl("td",{text:d.message,cls:"arete-err-msg"}),(d.message.includes("Tab Character Error")||d.message.includes("Missing 'cards' list"))&&(l=!0)}),l){let c=e.createDiv({cls:"arete-btn-container",attr:{style:"margin-top: 1rem; text-align: right;"}}).createEl("button",{text:"\u2728 Auto-Fix Issues",cls:"mod-cta"});c.addEventListener("click",async()=>{c.disabled=!0,c.setText("Fixing..."),await this.plugin.runFix(this.filePath),this.close(),this.plugin.runCheck(this.filePath)})}e.createDiv({text:"Please check the console for more details.",cls:"arete-footer-note"})}}onClose(){let{contentEl:e}=this;e.empty()}};var ge=class extends O.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Arete Settings"}),e.createEl("h3",{text:"General"}),new O.Setting(e).setName("Debug Mode").setDesc("Enable verbose logging and extra output.").addToggle(s=>s.setValue(this.plugin.settings.debug_mode).onChange(async r=>{this.plugin.settings.debug_mode=r,await this.plugin.saveSettings(),this.display()})),new O.Setting(e).setName("Preview Renderer").setDesc('"Obsidian" renders Markdown/LaTeX (Recommended). "Anki" passes raw text.').addDropdown(s=>s.addOption("obsidian","Obsidian (Markdown + LaTeX)").addOption("anki","Anki (Raw HTML/Text)").setValue(this.plugin.settings.renderer_mode).onChange(async r=>{this.plugin.settings.renderer_mode=r,await this.plugin.saveSettings(),this.plugin.templateRenderer.setMode(this.plugin.settings.renderer_mode)})),e.createEl("h3",{text:"Sync Options"}),new O.Setting(e).setName("Sync on Save").setDesc("Automatically sync the current file when you save (debounced).").addToggle(s=>s.setValue(this.plugin.settings.sync_on_save).onChange(async r=>{this.plugin.settings.sync_on_save=r,await this.plugin.saveSettings()})),this.plugin.settings.sync_on_save&&new O.Setting(e).setName("Debounce Delay (ms)").setDesc("Wait this long after last edit before syncing.").addSlider(s=>s.setLimits(500,5e3,500).setValue(this.plugin.settings.sync_on_save_delay).setDynamicTooltip().onChange(async r=>{this.plugin.settings.sync_on_save_delay=r,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Python Environment"}),new O.Setting(e).setName("Python Executable").setDesc("Path to python3 or arete executable").addText(s=>s.setPlaceholder("python3").setValue(this.plugin.settings.python_path).onChange(async r=>{this.plugin.settings.python_path=r,await this.plugin.saveSettings()})),new O.Setting(e).setName("Arete Script Path").setDesc("Absolute path to arete/main.py. Leave empty for global binary.").addText(s=>s.setPlaceholder("/path/to/arete/main.py").setValue(this.plugin.settings.arete_script_path).onChange(async r=>{this.plugin.settings.arete_script_path=r,await this.plugin.saveSettings()})),new O.Setting(e).setName("Project Root").setDesc('Absolute path to the Arete project root (containing pyproject.toml). Required for "uv run".').addText(s=>s.setPlaceholder("/path/to/arete").setValue(this.plugin.settings.project_root).onChange(async r=>{this.plugin.settings.project_root=r,await this.plugin.saveSettings()})),new O.Setting(e).setName("Parallel Workers").setDesc("Number of sync workers. Higher is faster but may stress Anki.").addSlider(s=>s.setLimits(1,16,1).setValue(this.plugin.settings.workers).setDynamicTooltip().onChange(async r=>{this.plugin.settings.workers=r,await this.plugin.saveSettings()})),new O.Setting(e).setName("Test Configuration").setDesc("Verify Python executable is valid.").addButton(s=>s.setButtonText("Test").onClick(async()=>{await this.plugin.testConfig()})),e.createEl("h3",{text:"Execution Mode"}),new O.Setting(e).setName("Mode").setDesc("CLI (Classic) spawns a process for each sync. Server (Faster) keeps a background process running.").addDropdown(s=>s.addOption("cli","CLI (Run Once)").addOption("server","Server (Background)").setValue(this.plugin.settings.execution_mode).onChange(async r=>{let i=this.plugin.settings.execution_mode;this.plugin.settings.execution_mode=r,await this.plugin.saveSettings(),r==="server"&&i==="cli"?this.plugin.serverManager.start():r==="cli"&&i==="server"&&this.plugin.serverManager.stop(),this.display()})),this.plugin.settings.execution_mode==="server"&&(new O.Setting(e).setName("Server Port").setDesc("Port for the Arete persistent server.").addText(s=>s.setValue(this.plugin.settings.server_port.toString()).onChange(async r=>{let i=parseInt(r);isNaN(i)||(this.plugin.settings.server_port=i,await this.plugin.saveSettings())})),new O.Setting(e).setName("Auto-Reload").setDesc("Automatically reload the server when code changes. (Requires Arete source/dev install).").addToggle(s=>s.setValue(this.plugin.settings.server_reload).onChange(async r=>{this.plugin.settings.server_reload=r,await this.plugin.saveSettings(),new O.Notice("Server restart required to apply reload setting.")})),new O.Setting(e).setName("Restart Server").setDesc("Stop and start the Arete server immediately.").addButton(s=>s.setButtonText("Restart").onClick(async()=>{await this.plugin.serverManager.restart()}))),e.createEl("h3",{text:"AI Assistant"}),new O.Setting(e).setName("API Provider").setDesc("LLM provider for the AI agent.").addDropdown(s=>s.addOption("openai","OpenAI").addOption("gemini","Google Gemini").addOption("anthropic","Anthropic").setValue(this.plugin.settings.ai_provider).onChange(async r=>{this.plugin.settings.ai_provider=r,await this.plugin.saveSettings()})),new O.Setting(e).setName("API Key").setDesc("API Key for the selected provider.").addText(s=>s.setPlaceholder("sk-...").setValue(this.plugin.settings.ai_api_key).onChange(async r=>{this.plugin.settings.ai_api_key=r,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Anki Connection"}),new O.Setting(e).setName("Backend").setDesc("Sync driver for Anki.").addDropdown(s=>s.addOption("auto","Auto (Recommended)").addOption("apy","Apy (Direct DB, Faster)").addOption("ankiconnect","AnkiConnect (Requires Anki running)").setValue(this.plugin.settings.backend).onChange(async r=>{this.plugin.settings.backend=r,await this.plugin.saveSettings()})),new O.Setting(e).setName("AnkiConnect URL").setDesc("URL for AnkiConnect API").addText(s=>s.setPlaceholder("http://localhost:8765").setValue(this.plugin.settings.anki_connect_url).onChange(async r=>{this.plugin.settings.anki_connect_url=r,await this.plugin.saveSettings()})).addButton(s=>s.setButtonText("Test").onClick(async()=>{var r;try{let i=await(0,O.requestUrl)({url:this.plugin.settings.anki_connect_url,method:"POST",body:JSON.stringify({action:"version",version:6}),contentType:"application/json"});(r=i.json)!=null&&r.result?new O.Notice(`\u2705 AnkiConnect v${i.json.result} connected!`,3e3):new O.Notice("\u26A0\uFE0F AnkiConnect responded but version unknown",5e3)}catch(i){new O.Notice("\u274C Cannot connect to AnkiConnect. Is Anki running?",8e3)}})),new O.Setting(e).setName("Media Directory").setDesc("Custom path for Anki media uploads (optional)").addText(s=>s.setPlaceholder("/path/to/Anki/collection.media").setValue(this.plugin.settings.anki_media_dir).onChange(async r=>{this.plugin.settings.anki_media_dir=r,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Card Health Analysis"}),new O.Setting(e).setName("Algorithm").setDesc("Scoring algorithm for identifying problematic cards.").addDropdown(s=>s.addOption("sm2","Classic (SM-2)").addOption("fsrs","FSRS (New Scheduler)").setValue(this.plugin.settings.stats_algorithm).onChange(async r=>{this.plugin.settings.stats_algorithm=r,this.plugin.statsCache={concepts:{},lastFetched:0},await this.plugin.saveSettings(),this.display()})),new O.Setting(e).setName("Lapse Threshold").setDesc("Cards with this many lapses are marked problematic.").addSlider(s=>s.setLimits(1,20,1).setValue(this.plugin.settings.stats_lapse_threshold).setDynamicTooltip().onChange(async r=>{this.plugin.settings.stats_lapse_threshold=r,await this.plugin.saveSettings()})),this.plugin.settings.stats_algorithm==="sm2"?new O.Setting(e).setName("Ease Threshold (%)").setDesc('Cards with ease below this are in "Ease Hell". Default: 250%').addSlider(s=>s.setLimits(130,300,10).setValue(this.plugin.settings.stats_ease_threshold/10).setDynamicTooltip().onChange(async r=>{this.plugin.settings.stats_ease_threshold=r*10,await this.plugin.saveSettings()})):new O.Setting(e).setName("Difficulty Threshold (FSRS)").setDesc("Cards with difficulty above this (0-100%) are problematic.").addSlider(s=>s.setLimits(50,100,5).setValue(this.plugin.settings.stats_difficulty_threshold*100).setDynamicTooltip().onChange(async r=>{this.plugin.settings.stats_difficulty_threshold=r/100,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Graph of Forgetting"}),new O.Setting(e).setName("Enable Graph Coloring").setDesc("Automatically add status tags (#arete/retention/...) to notes based on Anki stats.").addToggle(s=>s.setValue(this.plugin.settings.graph_coloring_enabled).onChange(async r=>{this.plugin.settings.graph_coloring_enabled=r,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.graph_coloring_enabled&&(new O.Setting(e).setName("Tag Prefix").setDesc("Prefix for retention tags. Examples: high, med, low will be appended.").addText(s=>s.setPlaceholder("arete/retention").setValue(this.plugin.settings.graph_tag_prefix).onChange(async r=>{this.plugin.settings.graph_tag_prefix=r,await this.plugin.saveSettings()})),new O.Setting(e).setName("Clear All Tags").setDesc("Remove all Arete retention tags from all files.").addButton(s=>s.setButtonText("Clear Tags").setWarning().onClick(async()=>{confirm("Are you sure you want to remove all retention tags?")&&await this.plugin.graphService.clearAllTags()}))),this.plugin.settings.debug_mode&&(e.createEl("h3",{text:"Debug"}),new O.Setting(e).setName("Sample Check Modal").setDesc("Opens a sample result modal for testing.").addButton(s=>s.setButtonText("Open").onClick(()=>{new Z(this.app,this.plugin,{ok:!0,stats:{deck:"Debug",cards_found:0}},"debug-file.md").open()}))),e.createEl("h3",{text:"Hotkeys"}),e.createEl("p",{text:"Click Configure to open Obsidian Hotkey settings.",cls:"setting-item-description"}),[{id:"obsidian-2-anki:arete-sync",name:"Sync"},{id:"obsidian-2-anki:arete-sync-current-file",name:"Sync Current File"},{id:"obsidian-2-anki:arete-sync-prune",name:"Sync (Prune Deleted Cards)"},{id:"obsidian-2-anki:arete-sync-force-all",name:"Sync (Force Re-upload All)"}].forEach(s=>{let r=this.app.commands.findCommand(s.id);if(!r)return;let o=(r.hotkeys||[]).map(l=>`${l.modifiers.join("+")}+${l.key}`).join(", ")||"No hotkey set";new O.Setting(e).setName(s.name).setDesc(`Current: ${o}`).addButton(l=>l.setButtonText("Configure").onClick(()=>{this.app.setting.openTabById("hotkeys");let d=this.app.setting.activeTab;d&&d.searchComponent&&(d.searchComponent.setValue("arete"),d.updateHotkeyVisibility())}))})}};var P=require("obsidian"),ht=require("child_process"),ne=q(require("path")),me=class{constructor(n,e,t){this.app=n,this.settings=e,this.pluginManifest=t}async runSync(n=!1,e=null,t=!1,s){this.settings.execution_mode==="server"?await this.runSyncServer(n,e,t,s):await this.runSyncCLI(n,e,t,s)}async runSyncServer(n,e,t,s){s("syncing"),new P.Notice(e?"Syncing file via Server...":"Starting sync via Server...");let r=this.app.vault.adapter,i=r.getBasePath?r.getBasePath():"",l=`http://127.0.0.1:${this.settings.server_port||8777}/sync`,d={vault_root:i,file_path:e,backend:this.settings.backend==="auto"?null:this.settings.backend,force:t?!0:null,prune:n?!0:null,clear_cache:t?!0:null,anki_connect_url:this.settings.anki_connect_url,workers:this.settings.workers};try{let c=await(0,P.requestUrl)({url:l,method:"POST",body:JSON.stringify(d),contentType:"application/json"});if(c.status===200){let h=c.json;h.success?(new P.Notice(`Sync Complete! (+${h.total_imported} notes)`),s("success")):(new P.Notice(`Sync finished with ${h.total_errors} errors.`),s("error","Sync Errors"))}else new P.Notice(`Server Error: ${c.status}`),s("error",`HTTP ${c.status}`)}catch(c){console.error("Server Sync Failed",c),c.message&&c.message.includes("Connection refused")?new P.Notice("Arete Server is not running! Switch to CLI mode or start server."):new P.Notice(`Sync Failed: ${c.message}`),s("error","Connection Failed")}}async runSyncCLI(n,e,t,s){s("syncing");let r=e?"Sycing file...":"Starting arete sync...";new P.Notice(r);let i=this.app.vault.adapter;if(!i.getBasePath){new P.Notice("Error: Cannot determine vault path."),s("error","No Vault Path");return}let o=i.getBasePath(),l=this.pluginManifest&&this.pluginManifest.dir||".obsidian/plugins/arete",d=o?ne.join(o,l,"arete_plugin.log"):"",c=v=>{let k=`[${new Date().toISOString()}] ${v}
`;console.log(v);try{require("fs").appendFileSync(d,k)}catch(b){console.error("Failed to write to log file",b)}};c(`

=== STARTING NEW SYNC RUN ===`),c(`Vault: ${o}`);let h=this.settings.python_path||"python3",p=this.settings.arete_script_path||"",u=this.settings.project_root||"",f=h.split(" "),g=f[0],m=f.slice(1),y=Object.assign({},process.env);if(p&&p.endsWith(".py")){c(`Trace: Detected .py script: ${p}`);let v=ne.dirname(p),w=ne.dirname(v);c(`Trace: Derived package root (PYTHONPATH): ${w}`),y.PYTHONPATH=w,m.push("-m","arete")}else{let v=m.some(k=>k.toLowerCase().includes("arete")),w=m.includes("-m");!v&&!w&&m.push("-m","arete")}this.settings.debug_mode&&m.push("--verbose"),m.push("sync"),n&&m.push("--prune"),t&&(m.push("--force"),m.push("--clear-cache")),this.settings.backend&&this.settings.backend!=="auto"&&(m.push("--backend"),m.push(this.settings.backend)),this.settings.workers&&(m.push("--workers"),m.push(this.settings.workers.toString())),this.settings.anki_connect_url&&this.settings.anki_connect_url!=="http://localhost:8765"&&(m.push("--anki-connect-url"),m.push(this.settings.anki_connect_url)),this.settings.anki_media_dir&&(m.push("--anki-media-dir"),m.push(this.settings.anki_media_dir)),m.push(e||o),c(`Spawning: ${g} ${m.join(" ")}`);try{let w=(0,ht.spawn)(g,m,{cwd:u||o,env:y}),k="";w.stdout.on("data",b=>{if(!b)return;b.toString().split(`
`).forEach($=>{$&&c(`STDOUT: ${$}`)})}),w.stderr.on("data",b=>{if(!b)return;let D=b.toString();k+=D,D.split(`
`).forEach(E=>{E&&c(`STDERR: ${E}`)})}),w.on("close",b=>{c(`Process exited with code ${b}`),b===0?(new P.Notice("arete sync completed successfully!"),s("success")):(s("error"),k.includes("AnkiConnect call failed")||k.includes("Connection refused")?new P.Notice("Error: Anki is not reachable. Is Anki open with AnkiConnect?"):k.includes("ModuleNotFoundError")?new P.Notice("Error: Python Dependencies missing. Check Python Executable path."):k.includes("No module named")?new P.Notice("Error: Invalid Python environment or arete not installed."):new P.Notice(`arete sync failed! (Code ${b}). See log.`))}),w.on("error",b=>{c(`Process Error: ${b.message}`),new P.Notice(`Failed to start: ${b.message}`),s("error",b.message)})}catch(v){c(`Exception during spawn: ${v.message}`),new P.Notice(`Exception: ${v.message}`),s("error",v.message)}}};var Q=require("obsidian"),ae=require("child_process"),N=q(require("path"));var ye=class{constructor(n,e){this.app=n,this.plugin=e,this.settings=e.settings}getPythonCommand(){let e=(this.settings.python_path||"python3").split(" ").filter(t=>t.trim()!=="");return{cmd:e[0],args:e.slice(1)}}getEnv(n){let e=Object.assign({},process.env);if(n){let t=N.join(n,"src"),s=e.PYTHONPATH||"";e.PYTHONPATH=s?`${s}:${t}`:t}if(process.platform==="darwin"&&process.env.HOME){let t=process.env.HOME,s=[N.join(t,".local","bin"),N.join(t,".cargo","bin"),"/opt/homebrew/bin","/usr/local/bin"],r=e.PATH||"";e.PATH=`${r}:${s.join(":")}`}return e}async getCheckResult(n){let e=this.settings.arete_script_path||"",{cmd:t,args:s}=this.getPythonCommand(),r=[...s],i=this.settings.project_root||void 0,o=this.getEnv(i);if(e&&e.endsWith(".py")){let l=N.dirname(e),d=N.dirname(l);o.PYTHONPATH=d,r.push("-m"),r.push("arete"),r.push("check-file")}else r.push("-m"),r.push("arete"),r.push("check-file");return r.push(n),r.push("--json"),new Promise((l,d)=>{let c=(0,ae.spawn)(t,r,{env:o,cwd:i}),h="",p="";c.stdout.on("data",u=>h+=u.toString()),c.stderr.on("data",u=>p+=u.toString()),c.on("close",u=>{try{let f=JSON.parse(h);l(f)}catch(f){console.error("Failed to parse check output",h),console.error("Stderr:",p);try{let y=h.match(/\{[\s\S]*\}/);if(y){let v=JSON.parse(y[0]);l(v);return}}catch(y){}let g=h.trim().substring(0,200),m=p.trim().substring(0,200);d(new Error(`Parse Error. Stdout: "${g}" Stderr: "${m}"`))}}),c.on("error",u=>{d(u)})})}async runCheck(n){new Q.Notice("Checking file...");try{let e=await this.getCheckResult(n);new Z(this.app,this.plugin,e,n).open()}catch(e){new Q.Notice(`Error: ${e.message}`)}}async runFix(n){let t=this.settings.arete_script_path,{cmd:s,args:r}=this.getPythonCommand(),i=[...r],o=this.settings.project_root||void 0,l=this.getEnv(o);if(t&&t.endsWith(".py")){let d=N.dirname(t),c=N.dirname(d);l.PYTHONPATH=c}return i.push("-m"),i.push("arete"),i.push("fix-file"),i.push(n),new Promise(d=>{(0,ae.spawn)(s,i,{env:l,cwd:o}).on("close",h=>{h===0?new Q.Notice("\u2728 File auto-fixed!"):new Q.Notice("\u274C Fix failed (check console)"),d()})})}async testConfig(){new Q.Notice("Testing configuration...");let n=this.settings.python_path,e=this.settings.project_root||void 0,t=this.getEnv(e);if(!n){new Q.Notice("Error: Python Executable setting is empty.");return}let s=`${n} -c "import arete; print('Arete module found')"`;(0,ae.exec)(s,{cwd:e,env:t},(r,i,o)=>{if(r){console.error("Test Config Failed:",r);let l=o||i||r.message;new Q.Notice(`Error: Command failed. ${l.substring(0,200)}`)}else new Q.Notice("Success: Python found & Arete module available.")})}async checkVaultIntegrity(){new Q.Notice("Running Integrity Check...");let n=this.app.vault.getMarkdownFiles(),e=0,t=0;console.log("--- Arete Integrity Check ---");for(let s of n){t++;let r=this.app.metadataCache.getFileCache(s);(await this.app.vault.read(s)).startsWith(`---
`)&&(!r||!r.frontmatter)&&(console.error(`[FAIL] ${s.path}: Has YAML block, but Obsidian Cache has no frontmatter! (Likely Invalid Properties)`),e++)}console.log(`Integrity Check Complete. ${t} files checked. ${e} potential issues.`),e>0?new Q.Notice(`Found ${e} files with Invalid Properties (Check Console)`):new Q.Notice("Integrity Check Passed (Obsidian parses all YAML correctly)")}};var pt=require("obsidian"),ve=class{constructor(n){this.settings=n}async chat(n){if(this.settings.execution_mode!=="server")throw new Error("Arete Server is not running. Please enable Server mode in settings.");if(!this.settings.ai_api_key)throw new Error("AI API Key is missing. Please configure it in settings.");let t=`http://localhost:${this.settings.server_port||8777}/agent/chat`;try{let s=await(0,pt.requestUrl)({url:t,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:n,api_key:this.settings.ai_api_key,provider:this.settings.ai_provider})});if(s.status!==200){let r=s.text||"No detail provided";throw new Error(`Server returned status ${s.status}: ${r}`)}return s.json}catch(s){throw console.error("Arete Agent Error:",s),s}}};var ns=Object.prototype.toString,J=Array.isArray||function(n){return ns.call(n)==="[object Array]"};function Ie(a){return typeof a=="function"}function as(a){return J(a)?"array":typeof a}function Me(a){return a.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function ut(a,n){return a!=null&&typeof a=="object"&&n in a}function is(a,n){return a!=null&&typeof a!="object"&&a.hasOwnProperty&&a.hasOwnProperty(n)}var os=RegExp.prototype.test;function cs(a,n){return os.call(a,n)}var ls=/\S/;function ds(a){return!cs(ls,a)}var hs={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function ps(a){return String(a).replace(/[&<>"'`=\/]/g,function(e){return hs[e]})}var us=/\s*/,fs=/\s+/,ft=/\s*=/,gs=/\s*\}/,ms=/#|\^|\/|>|\{|&|=|!/;function ys(a,n){if(!a)return[];var e=!1,t=[],s=[],r=[],i=!1,o=!1,l="",d=0;function c(){if(i&&!o)for(;r.length;)delete s[r.pop()];else r=[];i=!1,o=!1}var h,p,u;function f(E){if(typeof E=="string"&&(E=E.split(fs,2)),!J(E)||E.length!==2)throw new Error("Invalid tags: "+E);h=new RegExp(Me(E[0])+"\\s*"),p=new RegExp("\\s*"+Me(E[1])),u=new RegExp("\\s*"+Me("}"+E[1]))}f(n||L.tags);for(var g=new oe(a),m,y,v,w,k,b;!g.eos();){if(m=g.pos,v=g.scanUntil(h),v)for(var D=0,$=v.length;D<$;++D)w=v.charAt(D),ds(w)?(r.push(s.length),l+=w):(o=!0,e=!0,l+=" "),s.push(["text",w,m,m+1]),m+=1,w===`
`&&(c(),l="",d=0,e=!1);if(!g.scan(h))break;if(i=!0,y=g.scan(ms)||"name",g.scan(us),y==="="?(v=g.scanUntil(ft),g.scan(ft),g.scanUntil(p)):y==="{"?(v=g.scanUntil(u),g.scan(gs),g.scanUntil(p),y="&"):v=g.scanUntil(p),!g.scan(p))throw new Error("Unclosed tag at "+g.pos);if(y==">"?k=[y,v,m,g.pos,l,d,e]:k=[y,v,m,g.pos],d++,s.push(k),y==="#"||y==="^")t.push(k);else if(y==="/"){if(b=t.pop(),!b)throw new Error('Unopened section "'+v+'" at '+m);if(b[1]!==v)throw new Error('Unclosed section "'+b[1]+'" at '+m)}else y==="name"||y==="{"||y==="&"?o=!0:y==="="&&f(v)}if(c(),b=t.pop(),b)throw new Error('Unclosed section "'+b[1]+'" at '+g.pos);return Os(vs(s))}function vs(a){for(var n=[],e,t,s=0,r=a.length;s<r;++s)e=a[s],e&&(e[0]==="text"&&t&&t[0]==="text"?(t[1]+=e[1],t[3]=e[3]):(n.push(e),t=e));return n}function Os(a){for(var n=[],e=n,t=[],s,r,i=0,o=a.length;i<o;++i)switch(s=a[i],s[0]){case"#":case"^":e.push(s),t.push(s),e=s[4]=[];break;case"/":r=t.pop(),r[5]=s[2],e=t.length>0?t[t.length-1][4]:n;break;default:e.push(s)}return n}function oe(a){this.string=a,this.tail=a,this.pos=0}oe.prototype.eos=function(){return this.tail===""};oe.prototype.scan=function(n){var e=this.tail.match(n);if(!e||e.index!==0)return"";var t=e[0];return this.tail=this.tail.substring(t.length),this.pos+=t.length,t};oe.prototype.scanUntil=function(n){var e=this.tail.search(n),t;switch(e){case-1:t=this.tail,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,e),this.tail=this.tail.substring(e)}return this.pos+=t.length,t};function K(a,n){this.view=a,this.cache={".":this.view},this.parent=n}K.prototype.push=function(n){return new K(n,this)};K.prototype.lookup=function(n){var e=this.cache,t;if(e.hasOwnProperty(n))t=e[n];else{for(var s=this,r,i,o,l=!1;s;){if(n.indexOf(".")>0)for(r=s.view,i=n.split("."),o=0;r!=null&&o<i.length;)o===i.length-1&&(l=ut(r,i[o])||is(r,i[o])),r=r[i[o++]];else r=s.view[n],l=ut(s.view,n);if(l){t=r;break}s=s.parent}e[n]=t}return Ie(t)&&(t=t.call(this.view)),t};function A(){this.templateCache={_cache:{},set:function(n,e){this._cache[n]=e},get:function(n){return this._cache[n]},clear:function(){this._cache={}}}}A.prototype.clearCache=function(){typeof this.templateCache!="undefined"&&this.templateCache.clear()};A.prototype.parse=function(n,e){var t=this.templateCache,s=n+":"+(e||L.tags).join(":"),r=typeof t!="undefined",i=r?t.get(s):void 0;return i==null&&(i=ys(n,e),r&&t.set(s,i)),i};A.prototype.render=function(n,e,t,s){var r=this.getConfigTags(s),i=this.parse(n,r),o=e instanceof K?e:new K(e,void 0);return this.renderTokens(i,o,t,n,s)};A.prototype.renderTokens=function(n,e,t,s,r){for(var i="",o,l,d,c=0,h=n.length;c<h;++c)d=void 0,o=n[c],l=o[0],l==="#"?d=this.renderSection(o,e,t,s,r):l==="^"?d=this.renderInverted(o,e,t,s,r):l===">"?d=this.renderPartial(o,e,t,r):l==="&"?d=this.unescapedValue(o,e):l==="name"?d=this.escapedValue(o,e,r):l==="text"&&(d=this.rawValue(o)),d!==void 0&&(i+=d);return i};A.prototype.renderSection=function(n,e,t,s,r){var i=this,o="",l=e.lookup(n[1]);function d(p){return i.render(p,e,t,r)}if(l){if(J(l))for(var c=0,h=l.length;c<h;++c)o+=this.renderTokens(n[4],e.push(l[c]),t,s,r);else if(typeof l=="object"||typeof l=="string"||typeof l=="number")o+=this.renderTokens(n[4],e.push(l),t,s,r);else if(Ie(l)){if(typeof s!="string")throw new Error("Cannot use higher-order sections without the original template");l=l.call(e.view,s.slice(n[3],n[5]),d),l!=null&&(o+=l)}else o+=this.renderTokens(n[4],e,t,s,r);return o}};A.prototype.renderInverted=function(n,e,t,s,r){var i=e.lookup(n[1]);if(!i||J(i)&&i.length===0)return this.renderTokens(n[4],e,t,s,r)};A.prototype.indentPartial=function(n,e,t){for(var s=e.replace(/[^ \t]/g,""),r=n.split(`
`),i=0;i<r.length;i++)r[i].length&&(i>0||!t)&&(r[i]=s+r[i]);return r.join(`
`)};A.prototype.renderPartial=function(n,e,t,s){if(t){var r=this.getConfigTags(s),i=Ie(t)?t(n[1]):t[n[1]];if(i!=null){var o=n[6],l=n[5],d=n[4],c=i;l==0&&d&&(c=this.indentPartial(i,d,o));var h=this.parse(c,r);return this.renderTokens(h,e,t,c,s)}}};A.prototype.unescapedValue=function(n,e){var t=e.lookup(n[1]);if(t!=null)return t};A.prototype.escapedValue=function(n,e,t){var s=this.getConfigEscape(t)||L.escape,r=e.lookup(n[1]);if(r!=null)return typeof r=="number"&&s===L.escape?String(r):s(r)};A.prototype.rawValue=function(n){return n[1]};A.prototype.getConfigTags=function(n){return J(n)?n:n&&typeof n=="object"?n.tags:void 0};A.prototype.getConfigEscape=function(n){if(n&&typeof n=="object"&&!J(n))return n.escape};var L={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(a){ie.templateCache=a},get templateCache(){return ie.templateCache}},ie=new A;L.clearCache=function(){return ie.clearCache()};L.parse=function(n,e){return ie.parse(n,e)};L.render=function(n,e,t,s){if(typeof n!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+as(n)+'" was given as the first argument for mustache#render(template, view, partials)');return ie.render(n,e,t,s)};L.escape=ps;L.Scanner=oe;L.Context=K;L.Writer=A;var Fe=L;var gt=require("obsidian"),Oe=class{constructor(n,e){this.cache=new Map;this.mode="obsidian";this.app=n,this.repo=e}setMode(n){this.mode=n}async preloadModel(n){if(console.log(`[Arete] Preloading model: ${n}`),this.cache.has(n)){console.log(`[Arete] Model ${n} found in cache.`);return}try{let[e,t]=await Promise.all([this.repo.modelStyling(n),this.repo.modelTemplates(n)]);this.cache.set(n,{css:e,templates:t}),console.log(`[Arete] Model ${n} cached successfully.`)}catch(e){console.warn(`Failed to load model data for ${n}`,e)}}async render(n,e,t){console.log(`[Arete] Render request for ${n} (${e})`),this.cache.has(n)||await this.preloadModel(n);let s=this.cache.get(n);if(!s)return null;let r=Object.keys(s.templates);if(r.length===0)return console.warn(`[Arete] No card templates found for model: ${n}`),null;let i=r[0],o=s.templates[i];console.log(`[Arete] Using Card Type: ${i}`,o);let l=o[e];if(!l)return console.warn(`[Arete] Template type '${e}' not found in card '${i}'`),null;let d={},c={};if(this.mode==="obsidian")for(let p of Object.keys(t)){let u=t[p];if(!u){c[p]="";continue}let f=document.createElement("div");f.style.display="none",document.body.appendChild(f);try{await gt.MarkdownRenderer.render(this.app,u,f,"",null),c[p]=f.innerHTML}finally{document.body.removeChild(f)}}else Object.assign(c,t);Object.assign(d,c),Object.keys(c).forEach(p=>{let u=c[p],f=p.toLowerCase(),g=f.charAt(0).toUpperCase()+f.slice(1);f in d||(d[f]=u),g in d||(d[g]=u)}),console.log("[Arete] Template Render View:",d),console.log(`[Arete] Template raw (${e}):`,l);let h=p=>p.replace(/\{\{(?!\{|#|\^|\/|&)(.+?)\}\}/g,"{{{$1}}}");if(e==="Back"&&o.Front)try{let p=h(o.Front),u=Fe.render(p,d);d.FrontSide=u}catch(p){console.warn("Failed to render FrontSide",p)}try{let p=h(l),u=Fe.render(p,d);return console.log(`[Arete] Rendered HTML (${e}):`,u),{html:u,css:s.css}}catch(p){return console.error("Mustache render error",p),null}}};var Ve=require("obsidian");var be=require("obsidian"),mt=require("child_process"),Xe=q(require("path")),ee=class{constructor(n){this.settings=n,this.url=`http://127.0.0.1:${n.server_port||8777}`}async invoke(n,e={}){return this.settings.execution_mode==="cli"?this.invokeCLI(n,e):this.invokeServer(n,e)}async invokeServer(n,e={}){let t=`http://127.0.0.1:${this.settings.server_port||8777}`;console.log(`[Arete] Server Invoke: ${n}`,e);let s={...e,backend:this.settings.backend,anki_connect_url:this.settings.anki_connect_url};try{let r=await(0,be.requestUrl)({url:`${t}${n}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),throw:!1});if(r.status>=300)throw new Error(`Server returned ${r.status}: ${r.text}`);return r.json}catch(r){throw console.error(`Arete Server Error (${n}):`,r),r}}async invokeCLI(n,e){console.log(`[Arete] CLI Invoke: ${n}`,e);let t=["anki"];if(n==="/anki/cards/suspend")t.push("cards-suspend"),t.push("--cids"),t.push(JSON.stringify(e.cids||[]));else if(n==="/anki/cards/unsuspend")t.push("cards-unsuspend"),t.push("--cids"),t.push(JSON.stringify(e.cids||[]));else if(n.startsWith("/anki/models/")){let s=n.split("/");if(s.length>=5){let r=decodeURIComponent(s[3]),i=s[4].split("?")[0];i==="styling"?(t.push("models-styling"),t.push(r)):i==="templates"&&(t.push("models-templates"),t.push(r))}}else if(n==="/anki/stats")t.push("stats"),t.push("--nids"),t.push(JSON.stringify(e.nids||[]));else if(n==="/anki/browse")t.push("browse"),t.push("--query"),t.push(e.query);else throw new Error(`CLI Endpoint not supported: ${n}`);return this.settings.backend&&this.settings.backend!=="auto"&&t.push("--backend",this.settings.backend),this.settings.anki_connect_url&&t.push("--anki-connect-url",this.settings.anki_connect_url),new Promise((s,r)=>{let i=this.settings.python_path||"python3",o=this.settings.arete_script_path||"",l=this.settings.project_root||"",d=i.split(" "),c=d[0],h=d.slice(1),p=Object.assign({},process.env);if(o&&o.endsWith(".py")){let v=Xe.dirname(o),w=Xe.dirname(v);p.PYTHONPATH=w,h.push("-m","arete")}else h.includes("-m")||h.push("-m","arete");let u=[...h,...t],f=l||".";console.log(`[Arete] Spawning: ${c} ${u.join(" ")}`);let g=(0,mt.spawn)(c,u,{cwd:f,env:p}),m="",y="";g.stdout.on("data",v=>m+=v.toString()),g.stderr.on("data",v=>y+=v.toString()),g.on("close",v=>{var w;if(v===0){let k=m.trim();try{s(JSON.parse(k))}catch(b){let D=k.search(/[[{]/),$=k.lastIndexOf(((w=k.match(/[\]}]/))==null?void 0:w[0])||"");if(D!==-1&&$!==-1&&$>=D){let E=k.substring(D,$+1);try{s(JSON.parse(E));return}catch(bt){console.error("[Arete] Failed to parse extracted JSON block:",bt)}}s({output:m})}}else r(new Error(`CLI Error (${v}): ${y}`))})})}async modelStyling(n){var r;let e=`/anki/models/${encodeURIComponent(n)}/styling`;if(this.settings.execution_mode==="cli")return(await this.invokeCLI(e,{})).css||"";let t=new URLSearchParams({backend:this.settings.backend||"",anki_connect_url:this.settings.anki_connect_url||""}),s=await(0,be.requestUrl)(`${this.url}${e}?${t.toString()}`);return s.status!==200?"":((r=s.json)==null?void 0:r.css)||""}async modelTemplates(n){let e=`/anki/models/${encodeURIComponent(n)}/templates`;if(this.settings.execution_mode==="cli")return this.invokeCLI(e,{});let t=new URLSearchParams({backend:this.settings.backend||"",anki_connect_url:this.settings.anki_connect_url||""}),s=await(0,be.requestUrl)(`${this.url}${e}?${t.toString()}`);return s.status!==200?{}:s.json||{}}async version(){return 6}async suspendCards(n){return(await this.invoke("/anki/cards/suspend",{cids:n})).ok}async unsuspendCards(n){return(await this.invoke("/anki/cards/unsuspend",{cids:n})).ok}async getCardInfo(n){return[]}async browse(n){let e=await this.invoke("/anki/browse",{query:n});return e&&e.ok}};var we=class{constructor(n,e,t){this.app=n,this.settings=e,this.cache=t||{concepts:{},lastFetched:0},this.client=new ee(e)}getCache(){return this.cache}async refreshStats(){var d;let n=this.app.vault.getMarkdownFiles(),e=new Map,t=new Map,s={},r={};for(let c of n){let h=this.app.metadataCache.getFileCache(c);if((d=h==null?void 0:h.frontmatter)!=null&&d.cards){let p=h.frontmatter.cards,u=h.frontmatter.deck;Array.isArray(p)&&p.length>0&&(t.set(c.path,c),s[c.path]={filePath:c.path,fileName:c.name,primaryDeck:u||"Unknown",totalCards:0,problematicCardsCount:0,problematicCards:[],cardStats:{},averageEase:0,averageDifficulty:null,difficultyCount:0,totalLapses:0,score:0,lastUpdated:Date.now()},r[c.path]={},p.forEach((f,g)=>{if(f&&f.nid){let m=parseInt(f.nid);isNaN(m)||e.set(m,{file:c,index:g,front:f.front||f.Front||"Unknown",back:f.back||f.Back||""})}}))}}if(e.size===0)return new Ve.Notice("No linked Anki cards found in vault."),[];let i=Array.from(e.keys()),o=await this.fetchAnkiCardStats(i);for(let c of o){let h=e.get(c.noteId);if(!h)continue;let p=s[h.file.path];if(!p)continue;c.front=h.front,p.cardStats[c.cardId]=c;let u=p.cardStats[c.noteId];if(u){let y=!1;this.settings.stats_algorithm==="fsrs"?c.difficulty!==void 0&&(u.difficulty===void 0||c.difficulty>u.difficulty)&&(y=!0):c.ease<u.ease&&(y=!0),!y&&c.lapses>u.lapses&&(this.settings.stats_algorithm==="fsrs"?c.difficulty===u.difficulty&&(y=!0):c.ease===u.ease&&(y=!0)),y&&(p.cardStats[c.noteId]=c)}else p.cardStats[c.noteId]=c;p.totalCards++,p.totalLapses+=c.lapses,p.averageEase+=c.ease,c.difficulty!==void 0&&c.difficulty!==null&&(p.averageDifficulty===null&&(p.averageDifficulty=0),p.averageDifficulty+=c.difficulty,p.difficultyCount=(p.difficultyCount||0)+1);let f=c.deckName||"Default";r[h.file.path][f]||(r[h.file.path][f]=0),r[h.file.path][f]++;let g=!1,m=[];c.lapses>=this.settings.stats_lapse_threshold&&(g=!0,m.push(`Lapses: ${c.lapses}`)),this.settings.stats_algorithm==="fsrs"?c.difficulty!==void 0&&c.difficulty>this.settings.stats_difficulty_threshold&&(g=!0,m.push(`Diff: ${(c.difficulty*100).toFixed(0)}%`)):c.ease<this.settings.stats_ease_threshold&&(g=!0,m.push(`Ease: ${(c.ease/10).toFixed(0)}%`)),g&&(p.problematicCardsCount++,p.problematicCards.push({front:h.front,back:h.back,cardId:c.cardId,noteId:c.noteId,lapses:c.lapses,ease:c.ease,difficulty:c.difficulty,deckName:f,issue:m.join(", ")}))}let l=[];for(let c in s){let h=s[c];if(h.totalCards>0&&(h.averageEase=Math.round(h.averageEase/h.totalCards),h.difficultyCount&&h.difficultyCount>0?h.averageDifficulty=parseFloat((h.averageDifficulty/h.difficultyCount).toFixed(2)):h.averageDifficulty=null,h.score=h.problematicCardsCount/h.totalCards,h.primaryDeck==="Unknown")){let p=r[c],u=0,f="Unknown";for(let g in p)p[g]>u&&(u=p[g],f=g);h.primaryDeck=f}l.push(h)}return this.cache.concepts=s,this.cache.lastFetched=Date.now(),l.sort((c,h)=>h.score-c.score)}async fetchAnkiCardStats(n){try{let e=await this.client.invoke("/anki/stats",{nids:n});if(Array.isArray(e))return e.map(t=>({cardId:t.card_id,noteId:t.note_id,lapses:t.lapses,ease:t.ease,difficulty:t.difficulty,deckName:t.deck_name,interval:t.interval,due:t.due,reps:t.reps,averageTime:t.average_time,front:t.front}));console.warn("[Arete] Unexpected stats response format:",e)}catch(e){console.warn("[Arete] Failed to fetch stats via AreteClient:",e),new Ve.Notice("Failed to fetch stats from Arete.")}return[]}};var Ne=require("obsidian"),ke=class{constructor(n,e){this.app=n,this.settings=e}updateSettings(n){this.settings=n}async updateGraphTags(n,e){if(!this.settings.graph_coloring_enabled)return;let t=this.calculateRetentionState(e),s=`${this.settings.graph_tag_prefix}/${t}`,r=this.settings.graph_tag_prefix;await this.app.fileManager.processFrontMatter(n,i=>{let o=i.tags||[];Array.isArray(o)||(o=[o]),o=o.filter(l=>!l.startsWith(r)),o.push(s),i.tags=o})}async clearGraphTags(n){let e=this.settings.graph_tag_prefix;await this.app.fileManager.processFrontMatter(n,t=>{let s=t.tags;if(!s)return;Array.isArray(s)||(s=[s]);let r=s.filter(i=>!i.startsWith(e));r.length!==s.length&&(t.tags=r)})}calculateRetentionState(n){let e=n.score;return e>.2?"low":e>.1?"med":"high"}async clearAllTags(){let n=this.app.vault.getMarkdownFiles(),e=0;new Ne.Notice(`Arete: Clearing graph tags from ${n.length} files...`);for(let t of n)await this.clearGraphTags(t),e++;new Ne.Notice(`Arete: Cleared tags from ${e} files.`)}};var Se=class{constructor(n,e){this.app=n,this.plugin=e}async checkIntegrity(n){let e=n||this.app.vault.getMarkdownFiles(),t=[];for(let s of e){let r=this.getBrokenReferences(s);t.push(...r);let i=await this.getInvalidFrontmatter(s);i&&t.push(i)}return t}getBrokenReferences(n){let e=this.app.metadataCache.getFileCache(n);if(!e)return[];let t=[];if(e.frontmatter&&e.frontmatter.cards&&Array.isArray(e.frontmatter.cards))e.frontmatter.cards.forEach((i,o)=>{if(!i)return;[i.Front,i.front,i.Back,i.back,i.Text,i.text,i.Extra,i.extra].forEach(d=>{typeof d=="string"&&this.scanTextForBrokenLinks(d,n,t,`Card #${o+1}`)})});else if(e.embeds){for(let r of e.embeds)if(!this.app.metadataCache.getFirstLinkpathDest(r.link,n.path)){let o=[".png",".jpg",".jpeg",".gif",".bmp",".svg",".webp"],l=r.link.toLowerCase();o.some(c=>l.endsWith(c))&&t.push({sourceFile:n,linkText:r.original,linkPath:r.link,type:"image",position:r.position})}}return t}scanTextForBrokenLinks(n,e,t,s){let r=/(!?)\[\[([^|\]]+)(?:\|[^\]]+)?\]\]/g,i;for(;(i=r.exec(n))!==null;){let o=i[1]==="!",l=i[2],d=i[0];this.app.metadataCache.getFirstLinkpathDest(l,e.path)||o&&t.push({sourceFile:e,linkText:`${s}: ${d}`,linkPath:l,type:"image",position:null})}}async getInvalidFrontmatter(n){let e=this.app.metadataCache.getFileCache(n);if(e&&e.frontmatter)return null;let s=(await this.app.vault.read(n)).trimStart();if(/^---\s*\n\s*---/.test(s))return{sourceFile:n,linkText:"EMPTY YAML",linkPath:"Frontmatter",type:"invalid-yaml",errorMessage:"Empty Frontmatter. Please add content or remove the block.",position:null};if(s.startsWith(`---
`)||s.startsWith(`---\r
`)){let r="Obsidian failed to parse frontmatter.";try{let i=n.path,o=this.app.vault.adapter;"getBasePath"in o&&(i=`${o.getBasePath()}/${n.path}`);let l=await this.plugin.checkService.getCheckResult(i);if(!l.ok&&l.errors&&l.errors.length>0){let d=l.errors[0];r=`Line ${d.line}: ${d.message}`}}catch(i){console.error("Failed to run detailed check",i),r=`Check Failed: ${i.message||i}`}return{sourceFile:n,linkText:"INVALID YAML",linkPath:"Frontmatter",type:"invalid-yaml",errorMessage:r,position:null}}return null}};var Ce=class{constructor(n,e){this.app=n,this.areteClient=e}getLeeches(n){let e=[],t=Object.values(n.concepts);for(let s of t)if(s.problematicCards&&s.problematicCards.length>0)for(let r of s.problematicCards)e.push({...r,filePath:s.filePath,fileName:s.fileName,deck:s.primaryDeck});return e.sort((s,r)=>r.lapses-s.lapses)}async suspendCard(n){return this.areteClient.suspendCards([n])}async unsuspendCard(n){return this.areteClient.unsuspendCards([n])}};var W=require("obsidian"),yt=require("child_process"),Be=q(require("path")),xe=class{constructor(n,e,t){this.serverProcess=null;this.startPromise=null;this.app=n,this.settings=e,this.manifest=t}async start(n=!1){if(this.settings.execution_mode==="server")return this.startPromise&&!n?this.startPromise:(this.startPromise=(async()=>{if(await this.checkHealth()){if(!n){console.log("[Arete] Server already running.");return}console.log("[Arete] Force restarting server..."),await this.stop(),await new Promise(t=>setTimeout(t,1e3))}new W.Notice("Starting Arete Server...");try{this.spawnServer();let t=0,s=15;for(;t<s;){if(await new Promise(r=>setTimeout(r,1e3)),await this.checkHealth()){console.log("[Arete] Server is ready."),new W.Notice("Arete Server started successfully!");return}t++,t%5===0&&console.log(`[Arete] Still waiting for server... (${t}/${s})`)}console.error("[Arete] Server failed to respond to health check."),new W.Notice("Failed to connect to Arete Server after spawning.")}catch(t){console.error(t),new W.Notice("Failed to spawn Arete Server.")}})(),this.startPromise)}async stop(){if(this.settings.execution_mode!=="server")return;let n=this.settings.server_port||8777;try{await(0,W.requestUrl)({url:`http://127.0.0.1:${n}/shutdown`,method:"POST"}),console.log("[Arete] Shutdown signal sent.")}catch(e){}this.serverProcess&&(this.serverProcess.kill(),this.serverProcess=null)}async restart(){await this.start(!0)}async checkHealth(){let n=this.settings.server_port||8777;try{return(await(0,W.requestUrl)({url:`http://127.0.0.1:${n}/health`,throw:!1})).status===200}catch(e){return!1}}spawnServer(){var h,p;let n=this.settings.python_path||"python3",e=this.settings.arete_script_path||"",t=this.settings.project_root||"",s=n.split(" "),r=s[0],i=s.slice(1),o=Object.assign({},process.env);if(e&&e.endsWith(".py")){let u=Be.dirname(e),f=Be.dirname(u);o.PYTHONPATH=f,i.push("-m","arete")}else{let u=i.some(g=>g.toLowerCase().includes("arete")),f=i.includes("-m");!u&&!f&&i.push("-m","arete")}this.settings.server_reload&&i.push("--reload"),i.push("server","--port",(this.settings.server_port||8777).toString()),console.log(`[Arete] Spawning server: ${r} ${i.join(" ")}`);let l=this.app.vault.adapter,d=l.getBasePath?l.getBasePath():process.cwd(),c=t||d;this.serverProcess=(0,yt.spawn)(r,i,{cwd:c,env:o,stdio:["ignore","pipe","pipe"]}),(h=this.serverProcess.stdout)==null||h.on("data",u=>{console.log(`[Arete Server] ${u.toString().trim()}`)}),(p=this.serverProcess.stderr)==null||p.on("data",u=>{console.error(`[Arete Server Error] ${u.toString().trim()}`)}),this.serverProcess.on("error",u=>{console.error("[Arete] Server spawn error:",u)}),this.serverProcess.unref()}};var R=require("@codemirror/view"),Y=require("@codemirror/state"),Pe=Y.StateEffect.define(),bs=R.Decoration.line({class:"arete-card-highlight"}),Ye=class extends R.GutterMarker{constructor(e,t){super();this.targetLine=e,this.view=t}toDOM(){let e=document.createElement("div");return e.className="arete-skip-button",e.innerHTML="\u2193",e.title="Skip to end of frontmatter",e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.view.dispatch({effects:Pe.of(null)});let s=this.view.state.doc.line(this.targetLine+1);this.view.dispatch({effects:R.EditorView.scrollIntoView(s.from,{y:"start"})})}),e}},Ue=class extends R.GutterMarker{constructor(e,t,s,r,i,o,l,d){super();this.index=e,this.isStart=t,this.isEnd=s,this.lineIndex=r,this.totalLines=i,this.stats=o,this.algorithm=l,this.onClick=d}toDOM(){let e=document.createElement("div");if(e.className="arete-gutter-marker",e.dataset.cardIndex=String(this.index),e.style.position="relative",e.style.height="100%",e.style.width="100%",e.style.minWidth="20px",this.isStart&&e.classList.add("arete-gutter-start"),this.isEnd&&e.classList.add("arete-gutter-end"),this.isStart){let o=document.createElement("div");o.style.position="absolute",o.style.top="0",o.style.right="6px",o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="flex-end",o.style.gap="2px",o.style.zIndex="2",o.style.pointerEvents="none";let l=document.createElement("span");if(l.className="arete-gutter-badge",l.textContent=String(this.index+1),l.style.fontSize="9px",l.style.lineHeight="10px",l.style.fontWeight="bold",l.style.color="var(--text-muted)",l.style.position="static",o.appendChild(l),this.stats){let d="",c="var(--text-muted)";this.algorithm==="fsrs"?this.stats.difficulty!==void 0&&this.stats.difficulty!==null&&this.stats.difficulty>0?(d=`${Math.round(this.stats.difficulty*100)}%`,this.stats.difficulty>.9?c="var(--color-red)":this.stats.difficulty>.5?c="var(--color-orange)":c="var(--color-green)"):d="D:?":this.stats.ease&&this.stats.ease>0?d=`E:${Math.round(this.stats.ease/10)}%`:d="E:?";let h=document.createElement("span");if(h.textContent=d,h.style.fontSize="8px",h.style.lineHeight="9px",h.style.fontWeight="bold",h.style.color=c,o.appendChild(h),this.stats.lapses>0){let u=document.createElement("span");u.textContent=`${this.stats.lapses}L`,u.style.fontSize="8px",u.style.lineHeight="9px",u.style.fontWeight="bold";let f="var(--color-orange)";this.stats.lapses>5&&(f="var(--color-red)"),u.style.color=f,o.appendChild(u)}let p=[];this.stats.issue&&p.push(this.stats.issue),this.stats.difficulty&&p.push(`Difficulty: ${Math.round(this.stats.difficulty*100)}%`),this.stats.ease&&p.push(`Ease: ${Math.round(this.stats.ease/10)}%`),this.stats.lapses&&p.push(`Lapses: ${this.stats.lapses}`),e.title=p.join(`
`)}e.appendChild(o)}let t=document.createElement("div");t.className="arete-gutter-bar",t.style.position="absolute",t.style.right="0",t.style.top="0",t.style.width="3px",t.style.height="100%",t.style.marginTop="-1px",t.style.paddingBottom="1px",t.style.transition="width 0.15s ease-out, box-shadow 0.15s ease-out";let s="var(--interactive-accent)",r="var(--interactive-accent)";this.stats&&(this.stats.lapses>5||this.stats.difficulty&&this.stats.difficulty>.9)?(s="var(--color-red)",r="var(--color-red)"):this.stats&&this.stats.difficulty&&this.stats.difficulty>.5&&(s="var(--color-orange)",r="var(--color-orange)"),this.isEnd?t.style.background=`linear-gradient(to bottom, ${s}, transparent)`:t.style.backgroundColor=s,e.appendChild(t);let i=(o,l)=>{document.querySelectorAll(`.arete-gutter-marker[data-card-index="${this.index}"]`).forEach(d=>{let c=d.querySelector(".arete-gutter-bar");o?d.classList.add("arete-gutter-hover"):d.classList.remove("arete-gutter-hover"),l&&d.classList.add("arete-gutter-active");let h=d.classList.contains("arete-gutter-active"),p=d.classList.contains("arete-gutter-hover");h||p?c&&(c.style.width="6px",c.style.boxShadow=`0 0 10px ${r}`,c.style.zIndex="10"):c&&(c.style.width="3px",c.style.boxShadow="none",c.style.zIndex="0")})};return e.addEventListener("mouseenter",()=>i(!0,!1)),e.addEventListener("mouseleave",()=>i(!1,!1)),e.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),document.querySelectorAll(".arete-gutter-marker.arete-gutter-active").forEach(l=>{l.classList.remove("arete-gutter-active");let d=l.querySelector(".arete-gutter-bar");d&&(d.style.width="3px",d.style.boxShadow="none")}),i(!0,!0),this.onClick()}),e}};function We(a,n,e){for(let t=e;t>=n;t--)if(a[t].trim().length>0)return t;return n}function vt(a){let n=a.split(`
`),e=[],t=null,s=!1,r=!1,i=null,o=0;for(let l=0;l<n.length;l++){let d=n[l],c=d.trim();if(l===0&&c==="---"){s=!0;continue}if(s&&c==="---"){t=l,i&&e.push({index:i.index,startLine:i.startLine,endLine:We(n,i.startLine,l-1),nid:i.nid,cid:i.cid});break}if(s){if(c==="cards:"||c.startsWith("cards:")){r=!0;continue}if(r){if(c.startsWith("- ")&&(c.includes("model:")||c.includes("Front:")||c.includes("front:"))&&(i&&e.push({index:i.index,startLine:i.startLine,endLine:We(n,i.startLine,l-1),nid:i.nid,cid:i.cid}),i={startLine:l,index:o,nid:null,cid:null},o++),i){let h=c.match(/^nid:\s*['"]?(\d+)['"]?/);h&&(i.nid=parseInt(h[1]));let p=c.match(/^cid:\s*['"]?(\d+)['"]?/);p&&(i.cid=parseInt(p[1]))}r&&i&&!d.startsWith(" ")&&!d.startsWith("-")&&c.includes(":")&&c.length>0&&(e.push({index:i.index,startLine:i.startLine,endLine:We(n,i.startLine,l-1),nid:i.nid,cid:i.cid}),i=null,r=!1)}}}return{ranges:e,frontmatterEndLine:t,hasCards:e.length>0}}var qe=Y.StateField.define({create(a){return vt(a.doc.toString())},update(a,n){return n.docChanged?vt(n.state.doc.toString()):a}}),ws=Y.StateField.define({create(){return R.Decoration.none},update(a,n){for(let e of n.effects)if(e.is(Pe)){if(e.value===null)return R.Decoration.none;let t=e.value.cardIndex,r=n.state.field(qe).ranges.find(i=>i.index===t);if(r){let i=new Y.RangeSetBuilder;for(let o=r.startLine;o<=r.endLine&&!(o>=n.state.doc.lines);o++){let l=n.state.doc.line(o+1);i.add(l.from,l.from,bs)}return i.finish()}return R.Decoration.none}return a},provide:a=>R.EditorView.decorations.from(a)});function Ot(a,n=()=>null,e="fsrs"){return[qe,ws,(0,R.gutter)({class:"arete-card-gutter",markers:t=>{let s=t.state.field(qe),r=new Y.RangeSetBuilder;if(s.hasCards&&s.frontmatterEndLine!==null){let i=t.state.doc.line(1);r.add(i.from,i.from,new Ye(s.frontmatterEndLine,t))}for(let i of s.ranges)for(let o=i.startLine;o<=i.endLine&&!(o>=t.state.doc.lines);o++){let l=t.state.doc.line(o+1),d=o===i.startLine,c=o===i.endLine,h=i.endLine-i.startLine+1,p=o-i.startLine,u=null;(i.nid||i.cid)&&(u=n(i.nid,i.cid)),r.add(l.from,l.from,new Ue(i.index,d,c,p,h,u,e,()=>a(i.index)))}return r.finish()}})]}var De=class extends T.Plugin{constructor(){super(...arguments);this.syncOnSaveTimeout=null}async onload(){console.log("[Arete] Plugin Loading...");try{await this.loadSettings(),console.log("[Arete] Settings loaded:",this.settings),this.areteClient=new ee(this.settings),this.templateRenderer=new Oe(this.app,this.areteClient),this.templateRenderer.setMode(this.settings.renderer_mode),this.syncService=new me(this.app,this.settings,e=>{console.log(e)}),this.checkService=new ye(this.app,this),this.statsService=new we(this.app,this.settings,this.statsCache),this.graphService=new ke(this.app,this.settings),this.linkCheckerService=new Se(this.app,this),this.leechService=new Ce(this.app,this.areteClient),this.serverManager=new xe(this.app,this.settings,this.manifest),this.agentService=new ve(this.settings),this.serverManager.start(!0),this.app.workspace.onLayoutReady(async()=>{this.settings.execution_mode==="server"&&await this.serverManager.start(),console.log("[Arete] Refreshing stats on startup..."),this.statsService.refreshStats().then(async e=>{if(console.log("[Arete] Stats refresh complete, notifying views..."),this.settings.graph_coloring_enabled){console.log("[Arete] Updating Graph Tags...");for(let s of e){let r=this.app.vault.getAbstractFileByPath(s.filePath);r instanceof T.TFile&&await this.graphService.updateGraphTags(r,s)}new T.Notice("Graph tags updated.")}let t=this.app.workspace.getLeavesOfType(B)[0];if(t){let s=t.view;s.renderToolbar&&s.renderToolbar()}}).catch(e=>{console.error("[Arete] Failed to auto-refresh stats:",e)})}),console.log("[Arete] Services initialized"),this.registerView(B,e=>new he(e,this)),this.registerView(z,e=>new ue(e,this)),this.registerView(re,e=>new fe(e,this))}catch(e){console.error("[Arete] Failed to initialize plugin services:",e),new T.Notice("Arete Plugin failed to initialize! Check console.")}this.statusBarItem=this.addStatusBarItem(),this.statusBarItem.addClass("mod-clickable"),this.statusBarItem.addEventListener("click",()=>this.runSync()),this.updateStatusBar("idle"),this.addRibbonIcon("sheets-in-box","Sync to Anki (Arete)",e=>{this.runSync()}),this.addRibbonIcon("refresh-cw","Force Sync All (Arete)",e=>{this.runSync(!1,null,!0)}),this.addRibbonIcon("layout-dashboard","Arete Dashboard",e=>{this.activateDashboardView()}),this.addRibbonIcon("bot","Arete AI Assistant",e=>{this.activateChatView()}),this.addCommand({id:"arete-sync",name:"Sync",hotkeys:[{modifiers:["Mod","Shift"],key:"A"}],callback:()=>{this.runSync()}}),this.addCommand({id:"arete-check-file",name:"Check Current File",editorCallback:(e,t)=>{if(t.file){let s=this.app.vault.adapter,r=s.getBasePath?s.getBasePath():null;if(r){let i=Te.join(r,t.file.path);this.runCheck(i)}else new T.Notice("Error: Cannot determine vault path.")}}}),this.addCommand({id:"arete-check-integrity",name:"Debug: Vault Integrity Check",callback:()=>{this.checkVaultIntegrity()}}),this.addCommand({id:"arete-sync-current-file",name:"Sync Current File",callback:()=>{let e=this.app.workspace.getActiveFile();if(e){let t=this.app.vault.adapter,s=t.getBasePath?t.getBasePath():null;if(s){let r=Te.join(s,e.path);this.runSync(!1,r,!0)}else new T.Notice("Error: Cannot resolve file path.")}else new T.Notice("No active file to sync.")}}),this.addCommand({id:"arete-sync-prune",name:"Sync (Prune Deleted Cards)",callback:()=>{this.runSync(!0)}}),this.addCommand({id:"arete-sync-force-all",name:"Sync (Force Re-upload All)",callback:()=>{this.runSync(!1,null,!0)}}),this.addCommand({id:"arete-open-dashboard",name:"Open Dashboard",callback:()=>{this.activateDashboardView()}}),this.addCommand({id:"arete-graph-clear",name:"Graph: Clear Retention Tags",callback:async()=>{await this.graphService.clearAllTags()}}),this.addCommand({id:"arete-sync-stats",name:"Sync Stats (Refresh Anki Data)",callback:async()=>{new T.Notice("Refreshing Arete stats...");let e=await this.statsService.refreshStats();if(this.settings.graph_coloring_enabled){for(let s of e){let r=this.app.vault.getAbstractFileByPath(s.filePath);r instanceof T.TFile&&await this.graphService.updateGraphTags(r,s)}new T.Notice("Graph tags updated.")}let t=this.app.workspace.getLeavesOfType(B)[0];if(t){let s=t.view;s.renderToolbar&&s.renderToolbar()}new T.Notice("Stats refreshed.")}}),this.addSettingTab(new ge(this.app,this)),this.addRibbonIcon("file-code","Open YAML Editor",()=>{this.activateYamlEditorView()}),this.addCommand({id:"open-yaml-editor",name:"Open YAML Editor",callback:()=>{this.activateYamlEditorView()}}),this.registerEditorExtension(Ot(e=>{this.highlightCardLines(e),this.activateYamlEditorView(e)},(e,t)=>{var l,d,c,h;let s=this.app.workspace.getActiveFile();if(!s)return null;let r=this.statsService.getCache().concepts[s.path];if(!r)return null;let i=null;if(t&&(i=(l=r.problematicCards)==null?void 0:l.find(p=>p.cardId===t)),!i&&e&&(i=(d=r.problematicCards)==null?void 0:d.find(p=>p.noteId===e)),i)return i;let o=null;return t&&((c=r.cardStats)!=null&&c[t])?o=r.cardStats[t]:e&&((h=r.cardStats)!=null&&h[e])&&(o=r.cardStats[e]),o?{...o,issue:"",front:"",back:""}:null},this.settings.stats_algorithm)),this.registerEvent(this.app.vault.on("modify",e=>{this.settings.sync_on_save&&e.path.endsWith(".md")&&(this.syncOnSaveTimeout&&clearTimeout(this.syncOnSaveTimeout),this.syncOnSaveTimeout=setTimeout(async()=>{let t=this.app.vault.adapter,s=t.getBasePath?t.getBasePath():null;if(s){let r=Te.join(s,e.path);this.settings.debug_mode&&console.log("[Arete] Sync on save triggered for:",e.path),await this.runSync(!1,r,!1)}},this.settings.sync_on_save_delay))}))}highlightCardLines(e){let t=this.app.workspace.getMostRecentLeaf();if(!t||!(t.view instanceof T.MarkdownView))return;let s=t.view.editor.cm;s&&s.dispatch({effects:Pe.of({cardIndex:e})})}async activateChatView(){let{workspace:e}=this.app,t=null,s=e.getLeavesOfType(re);s.length>0?t=s[0]:(t=e.getRightLeaf(!1),await t.setViewState({type:re,active:!0})),e.revealLeaf(t)}async activateDashboardView(){let{workspace:e}=this.app,t=e.getLeavesOfType(z)[0];if(!t){let s=e.getRightLeaf(!1);s&&await s.setViewState({type:z,active:!0}),t=e.getLeavesOfType(z)[0]}t&&e.revealLeaf(t)}async activateYamlEditorView(e){let{workspace:t}=this.app,s=t.getLeavesOfType(B)[0];if(!s){let r=t.getRightLeaf(!1);r&&await r.setViewState({type:B,active:!0}),s=t.getLeavesOfType(B)[0]}if(s&&(t.revealLeaf(s),e!==void 0)){let r=s.view;r!=null&&r.focusCard&&r.focusCard(e)}}syncYamlEditorToCard(e){let{workspace:t}=this.app,s=t.getLeavesOfType(B)[0];if(s){let r=s.view;r!=null&&r.focusCard&&r.focusCard(e)}}onunload(){this.statusBarItem&&this.statusBarItem.empty(),this.serverManager&&this.serverManager.stop()}updateStatusBar(e,t){if(this.statusBarItem){if(this.statusBarItem.empty(),e==="idle"){let s=this.settings.last_sync_time;if(s){let r=this.formatTimeAgo(s);this.statusBarItem.setText(`\u{1F0CF} ${r}`),this.statusBarItem.title="Click to sync to Anki"}else this.statusBarItem.setText("\u{1F0CF} Arete"),this.statusBarItem.title="Never synced. Click to sync.";return}e==="syncing"?(this.statusBarItem.createSpan({cls:"arete-sb-icon",text:"\u{1F504} "}),this.statusBarItem.createSpan({text:"Syncing..."})):e==="success"?(this.statusBarItem.setText("\u2705 Synced"),setTimeout(()=>this.updateStatusBar("idle"),3e3)):e==="error"&&(this.statusBarItem.setText("\u274C Error"),this.statusBarItem.title=t||"Check logs")}}formatTimeAgo(e){let s=Date.now()-e,r=Math.floor(s/6e4),i=Math.floor(s/36e5),o=Math.floor(s/864e5);return r<1?"Just now":r<60?`${r}m ago`:i<24?`${i}h ago`:`${o}d ago`}notify(e,t="info"){let s={info:4e3,success:3e3,warning:6e3,error:1e4};new T.Notice(e,s[t])}async runSync(e=!1,t=null,s=!1){await this.syncService.runSync(e,t,s,this.updateStatusBar.bind(this)),this.settings.last_sync_time=Date.now(),await this.saveSettings()}async runCheck(e){await this.checkService.runCheck(e)}async runFix(e){await this.checkService.runFix(e)}async checkVaultIntegrity(){await this.checkService.checkVaultIntegrity()}async testConfig(){await this.checkService.testConfig()}async loadSettings(){let e=await this.loadData();this.settings=Object.assign({},je,e),this.statsCache=e==null?void 0:e.statsCache}async saveSettings(){await this.saveData({...this.settings,statsCache:this.statsCache}),this.syncService.settings=this.settings,this.checkService.settings=this.settings,this.statsService&&(this.statsService.settings=this.settings),this.graphService&&this.graphService.updateSettings(this.settings)}async saveStats(){this.statsService&&(this.statsCache=this.statsService.getCache(),await this.saveSettings())}};
/*! Bundled license information:

mustache/mustache.mjs:
  (*!
   * mustache.js - Logic-less {{mustache}} templates with JavaScript
   * http://github.com/janl/mustache.js
   *)
*/
