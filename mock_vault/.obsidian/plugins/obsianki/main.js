/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository
*/

var B=Object.create;var C=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var M=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var N=(d,u)=>{for(var t in u)C(d,t,{get:u[t],enumerable:!0})},T=(d,u,t,a)=>{if(u&&typeof u=="object"||typeof u=="function")for(let e of F(u))!O.call(d,e)&&e!==t&&C(d,e,{get:()=>u[e],enumerable:!(a=I(u,e))||a.enumerable});return d};var $=(d,u,t)=>(t=d!=null?B(M(d)):{},T(u||!d||!d.__esModule?C(t,"default",{value:d,enumerable:!0}):t,d)),V=d=>T(C({},"__esModule",{value:!0}),d);var L={};N(L,{CheckResultModal:()=>w,O2ASettingTab:()=>v,default:()=>P});module.exports=V(L);var s=require("obsidian"),S=require("child_process"),g=$(require("path")),H={pythonPath:"python3",o2aScriptPath:"",debugMode:!1,backend:"auto",workers:4,ankiConnectUrl:"http://localhost:8765",ankiMediaDir:""},P=class extends s.Plugin{async onload(){await this.loadSettings(),this.statusBarItem=this.addStatusBarItem(),this.updateStatusBar("idle");let t=this.addRibbonIcon("sheets-in-box","Sync to Anki (o2a)",a=>{this.runSync()});this.addCommand({id:"o2a-sync",name:"Sync",hotkeys:[{modifiers:["Mod","Shift"],key:"A"}],callback:()=>{this.runSync()}}),this.addCommand({id:"o2a-check-file",name:"Check Current File",editorCallback:(a,e)=>{if(e.file){let n=this.app.vault.adapter,i=n.getBasePath?n.getBasePath():null;if(i){let h=g.join(i,e.file.path);this.runCheck(h)}else new s.Notice("Error: Cannot determine vault path.")}}}),this.addCommand({id:"o2a-check-integrity",name:"Debug: Check Vault Integrity (Obsidian vs Linter)",callback:()=>{this.checkVaultIntegrity()}}),this.addCommand({id:"o2a-sync-current-file",name:"Sync Current File (Force Update)",callback:()=>{let a=this.app.workspace.getActiveFile();if(a){let e=this.app.vault.adapter,n=e.getBasePath?e.getBasePath():null;if(n){let i=g.join(n,a.path);this.runSync(!1,i,!0)}else new s.Notice("Error: Cannot resolve file path.")}else new s.Notice("No active file to sync.")}}),this.addCommand({id:"o2a-sync-prune",name:"Sync with Prune",callback:()=>{this.runSync(!0)}}),this.addSettingTab(new v(this.app,this))}onunload(){this.statusBarItem&&this.statusBarItem.empty()}updateStatusBar(t,a){this.statusBarItem&&(this.statusBarItem.empty(),t!=="idle"&&(t==="syncing"?(this.statusBarItem.createSpan({cls:"o2a-sb-icon",text:"\u{1F504} "}),this.statusBarItem.createSpan({text:"Anki Syncing..."})):t==="success"?(this.statusBarItem.setText("\u2705 Sync Complete"),setTimeout(()=>this.updateStatusBar("idle"),3e3)):t==="error"&&(this.statusBarItem.setText("\u274C Sync Error"),this.statusBarItem.title=a||"Check logs")))}async runCheck(t){new s.Notice("Checking file...");let a=this.settings.pythonPath||"python3",e=this.settings.o2aScriptPath||"",n=a,i=[],h=Object.assign({},process.env);if(e&&e.endsWith(".py")){let l=g.dirname(e),o=g.dirname(l);h.PYTHONPATH=o,i.push("-m"),i.push("o2a"),i.push("check-file")}else i.push("-m"),i.push("o2a"),i.push("check-file");i.push(t),i.push("--json");try{let l=(0,S.spawn)(n,i,{env:h}),o="",r="";l.stdout.on("data",y=>o+=y.toString()),l.stderr.on("data",y=>r+=y.toString()),l.on("close",y=>{try{let f=JSON.parse(o);new w(this.app,this,f,t).open()}catch(f){console.error("Failed to parse check output",o),new s.Notice("Check failed. See console.")}}),l.on("error",y=>{new s.Notice(`Error: ${y.message}`)})}catch(l){new s.Notice(`Error: ${l.message}`)}}async runSync(t=!1,a=null,e=!1){this.updateStatusBar("syncing");let n=a?"Sycing file...":"Starting o2a sync...";new s.Notice(n);let i=this.app.vault.adapter;if(!i.getBasePath){new s.Notice("Error: Cannot determine vault path."),this.updateStatusBar("error","No Vault Path");return}let h=i.getBasePath(),l=this.manifest&&this.manifest.dir||".obsidian/plugins/obsidian-2-anki",o=h?g.join(h,l,"o2a_plugin.log"):"",r=m=>{let p=`[${new Date().toISOString()}] ${m}
`;console.log(m);try{require("fs").appendFileSync(o,p)}catch(b){console.error("Failed to write to log file",b)}};r(`

=== STARTING NEW SYNC RUN ===`),r(`Vault: ${h}`);let y=this.settings.pythonPath||"python3",f=this.settings.o2aScriptPath||"",x=y,c=[],A=Object.assign({},process.env);if(f&&f.endsWith(".py")){r(`Trace: Detected .py script: ${f}`);let m=g.dirname(f),k=g.dirname(m);r(`Trace: Derived package root (PYTHONPATH): ${k}`),A.PYTHONPATH=k,c.push("-m"),c.push("o2a"),this.settings.debugMode&&c.push("--verbose"),c.push("sync")}else f?(r(`Trace: Using custom script/binary: ${f}`),c.push(f),this.settings.debugMode&&c.push("--verbose"),c.push("sync")):(r("Trace: No script path provided. Defaulting to 'python -m o2a'"),c.push("-m"),c.push("o2a"),this.settings.debugMode&&c.push("--verbose"),c.push("sync"));t&&c.push("--prune"),e&&c.push("--force"),this.settings.backend&&this.settings.backend!=="auto"&&(c.push("--backend"),c.push(this.settings.backend)),this.settings.workers&&(c.push("--workers"),c.push(this.settings.workers.toString())),this.settings.ankiConnectUrl&&this.settings.ankiConnectUrl!=="http://localhost:8765"&&(c.push("--anki-connect-url"),c.push(this.settings.ankiConnectUrl)),this.settings.ankiMediaDir&&(c.push("--anki-media-dir"),c.push(this.settings.ankiMediaDir)),c.push(a||h),r(`Spawning: ${x} ${c.join(" ")}`);try{let m=(0,S.spawn)(x,c,{cwd:h,env:A}),k="";m.stdout.on("data",p=>{if(!p)return;p.toString().split(`
`).forEach(E=>{E&&r(`STDOUT: ${E}`)})}),m.stderr.on("data",p=>{if(!p)return;let b=p.toString();k+=b,b.split(`
`).forEach(D=>{D&&r(`STDERR: ${D}`)})}),m.on("close",p=>{r(`Process exited with code ${p}`),p===0?(new s.Notice("o2a sync completed successfully!"),this.updateStatusBar("success")):(this.updateStatusBar("error"),k.includes("AnkiConnect call failed")||k.includes("Connection refused")?new s.Notice("Error: Anki is not reachable. Is Anki open with AnkiConnect?"):k.includes("ModuleNotFoundError")?new s.Notice("Error: Python Dependencies missing. Check Python Executable path."):k.includes("No module named")?new s.Notice("Error: Invalid Python environment or o2a not installed."):new s.Notice(`o2a sync failed! (Code ${p}). See log.`))}),m.on("error",p=>{r(`Process Error: ${p.message}`),new s.Notice(`Failed to start: ${p.message}`),this.updateStatusBar("error",p.message)})}catch(m){r(`Exception during spawn: ${m.message}`),new s.Notice(`Exception: ${m.message}`),this.updateStatusBar("error",m.message)}}async testConfig(){new s.Notice("Testing configuration...");let t=this.settings.pythonPath||"python3";try{let a=(0,S.spawn)(t,["--version"]);a.on("close",e=>{e===0?new s.Notice("Success: Python found."):new s.Notice("Error: Python command failed.")}),a.on("error",e=>{new s.Notice(`Error: Invalid Python Path. ${e.message}`)})}catch(a){new s.Notice(`Error: ${a.message}`)}}async loadSettings(){this.settings=Object.assign({},H,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async runFix(t){let a=this.settings,e=a.pythonPath||"python3",n=a.o2aScriptPath,i="",h=[];if(n&&n.endsWith(".py")){let o=g.dirname(a.o2aScriptPath);i=e,h=["-m","o2a","fix-file",t]}else i=e,h=["-m","o2a","fix-file",t];let l=Object.assign({},process.env);if(n&&n.endsWith(".py")){let o=g.dirname(n),r=g.dirname(o);l.PYTHONPATH=r}return new Promise(o=>{(0,S.spawn)(i,h,{env:l}).on("close",y=>{y===0?new s.Notice("\u2728 File auto-fixed!"):new s.Notice("\u274C Fix failed (check console)"),o()})})}async checkVaultIntegrity(){new s.Notice("Running Integrity Check...");let t=this.app.vault.getMarkdownFiles(),a=0,e=0;console.log("--- O2A Integrity Check ---");for(let n of t){e++;let i=this.app.metadataCache.getFileCache(n);(await this.app.vault.read(n)).startsWith(`---
`)&&(!i||!i.frontmatter)&&(console.error(`[FAIL] ${n.path}: Has YAML block, but Obsidian Cache has no frontmatter! (Likely Invalid Properties)`),a++)}console.log(`Integrity Check Complete. ${e} files checked. ${a} potential issues.`),a>0?new s.Notice(`Found ${a} files with Invalid Properties (Check Console)`):new s.Notice("Integrity Check Passed (Obsidian parses all YAML correctly)")}},v=class extends s.PluginSettingTab{constructor(t,a){super(t,a);this.plugin=a}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"O2A Settings"}),new s.Setting(t).setName("Python Executable").setDesc("Path to python3 or o2a executable").addText(e=>e.setPlaceholder("python3").setValue(this.plugin.settings.pythonPath).onChange(async n=>{this.plugin.settings.pythonPath=n,await this.plugin.saveSettings()})),new s.Setting(t).setName("O2A Script Path").setDesc("Absolute path to o2a/main.py. Leave empty if you are using a global binary.").addText(e=>e.setPlaceholder("/path/to/o2a/main.py").setValue(this.plugin.settings.o2aScriptPath).onChange(async n=>{this.plugin.settings.o2aScriptPath=n,await this.plugin.saveSettings()})),new s.Setting(t).setName("Debug Mode").setDesc("Enable verbose logging and extra output.").addToggle(e=>e.setValue(this.plugin.settings.debugMode).onChange(async n=>{this.plugin.settings.debugMode=n,await this.plugin.saveSettings()})),new s.Setting(t).setName("Anki Backend").setDesc("Manual override for the Anki sync driver.").addDropdown(e=>e.addOption("auto","Auto (Recommended)").addOption("apy","Apy (Direct DB Access, Faster)").addOption("ankiconnect","AnkiConnect (Requires Anki running)").setValue(this.plugin.settings.backend).onChange(async n=>{this.plugin.settings.backend=n,await this.plugin.saveSettings()})),new s.Setting(t).setName("Anki Connect URL").setDesc("URL for AnkiConnect API (default: http://localhost:8765)").addText(e=>e.setPlaceholder("http://localhost:8765").setValue(this.plugin.settings.ankiConnectUrl).onChange(async n=>{this.plugin.settings.ankiConnectUrl=n,await this.plugin.saveSettings()})),new s.Setting(t).setName("Anki Media Directory").setDesc("Custom path for Anki media uploads (optional)").addText(e=>e.setPlaceholder("/path/to/Anki/collection.media").setValue(this.plugin.settings.ankiMediaDir).onChange(async n=>{this.plugin.settings.ankiMediaDir=n,await this.plugin.saveSettings()})),new s.Setting(t).setName("Parallel Workers").setDesc("Number of parallel sync workers. Higher is faster but may stress AnkiConnect.").addSlider(e=>e.setLimits(1,16,1).setValue(this.plugin.settings.workers).setDynamicTooltip().onChange(async n=>{this.plugin.settings.workers=n,await this.plugin.saveSettings()})),new s.Setting(t).setName("Test Configuration").setDesc("Verifies that the Python Executable is valid.").addButton(e=>e.setButtonText("Test Config").onClick(async()=>{await this.plugin.testConfig()})),this.plugin.settings.debugMode&&new s.Setting(t).setName("Check Results (Debug)").setDesc("Opens a sample result modal for testing.").addButton(e=>e.setButtonText("Open Sample Modal").onClick(()=>{new w(this.app,this.plugin,{ok:!0,stats:{deck:"Debug",cards_found:0}},"debug-file.md").open()})),t.createEl("h2",{text:"Hotkeys"}),t.createEl("p",{text:"To modify hotkeys, click the button to open Obsidian Hotkey settings."}),[{id:"obsidian-2-anki:o2a-sync",name:"Sync"},{id:"obsidian-2-anki:o2a-sync-current-file",name:"Sync Current File"},{id:"obsidian-2-anki:o2a-sync-prune",name:"Sync with Prune"}].forEach(e=>{let n=this.app.commands.findCommand(e.id);if(!n)return;let h=(n.hotkeys||[]).map(l=>`${l.modifiers.join("+")}+${l.key}`).join(", ")||"No hotkey set";new s.Setting(t).setName(e.name).setDesc(`Current: ${h}`).addButton(l=>l.setButtonText("Configure").onClick(()=>{this.app.setting.openTabById("hotkeys");let o=this.app.setting.activeTab;o&&o.searchComponent&&(o.searchComponent.setValue("o2a"),o.updateHotkeyVisibility())}))})}},w=class extends s.Modal{constructor(t,a,e,n){super(t);this.plugin=a,this.result=e,this.filePath=n}onOpen(){let{contentEl:t}=this;t.addClass("o2a-modal");let a=t.createDiv({cls:"modal-header"});if(a.createEl("h2",{text:"O2A File Check"}),a.createEl("span",{text:g.basename(this.filePath),cls:"o2a-filename"}),this.result.ok){t.createDiv({text:"\u2705 Valid",cls:"o2a-success"});let e=t.createEl("ul",{cls:"o2a-stats"}),n=e.createEl("li");n.createSpan({text:"Deck",cls:"o2a-stats-label"}),n.createSpan({text:this.result.stats.deck||"None",cls:"o2a-stats-val"});let i=e.createEl("li");i.createSpan({text:"Cards Found",cls:"o2a-stats-label"}),i.createSpan({text:this.result.stats.cards_found.toString(),cls:"o2a-stats-val"})}else{t.createDiv({text:"\u274C Validation Failed",cls:"o2a-error"});let e=t.createEl("table",{cls:"o2a-error-table"}),i=e.createEl("thead").createEl("tr");i.createEl("th",{text:"Line"}),i.createEl("th",{text:"Error Message"});let h=e.createEl("tbody"),l=!1;if(this.result.errors.forEach(o=>{let r=h.createEl("tr");r.createEl("td",{text:o.line.toString(),cls:"o2a-error-line"}),r.createEl("td",{text:o.message,cls:"o2a-err-msg"}),(o.message.includes("Tab Character Error")||o.message.includes("Missing 'cards' list"))&&(l=!0)}),l){let r=t.createDiv({cls:"o2a-btn-container",attr:{style:"margin-top: 1rem; text-align: right;"}}).createEl("button",{text:"\u2728 Auto-Fix Issues",cls:"mod-cta"});r.addEventListener("click",async()=>{r.disabled=!0,r.setText("Fixing..."),await this.plugin.runFix(this.filePath),this.close(),this.plugin.runCheck(this.filePath)})}t.createDiv({text:'\u{1F4A1} Tip: Check for correct YAML indentation (2 spaces) and ensure "cards" list exists.',cls:"o2a-hint"})}}onClose(){let{contentEl:t}=this;t.empty()}};
