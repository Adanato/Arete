/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository
*/

var B=Object.create;var P=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var O=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var $=(h,p)=>{for(var t in p)P(h,t,{get:p[t],enumerable:!0})},D=(h,p,t,n)=>{if(p&&typeof p=="object"||typeof p=="function")for(let e of F(p))!N.call(h,e)&&e!==t&&P(h,e,{get:()=>p[e],enumerable:!(n=I(p,e))||n.enumerable});return h};var M=(h,p,t)=>(t=h!=null?B(O(h)):{},D(p||!h||!h.__esModule?P(t,"default",{value:h,enumerable:!0}):t,h)),V=h=>D(P({},"__esModule",{value:!0}),h);var L={};$(L,{default:()=>w});module.exports=V(L);var s=require("obsidian"),b=require("child_process"),u=M(require("path")),H={pythonPath:"python3",o2aScriptPath:"",debugMode:!1,backend:"auto",workers:4},w=class extends s.Plugin{async onload(){await this.loadSettings(),this.statusBarItem=this.addStatusBarItem(),this.updateStatusBar("idle");let t=this.addRibbonIcon("sheets-in-box","Sync to Anki (o2a)",n=>{this.runSync()});this.addCommand({id:"o2a-sync",name:"Sync",hotkeys:[{modifiers:["Mod","Shift"],key:"A"}],callback:()=>{this.runSync()}}),this.addCommand({id:"o2a-check-file",name:"Check Current File",editorCallback:(n,e)=>{if(e.file){let a=this.app.vault.adapter;if(a.getBasePath){let i=u.join(a.getBasePath(),e.file.path);this.runCheck(i)}}}}),this.addCommand({id:"o2a-check-integrity",name:"Debug: Check Vault Integrity (Obsidian vs Linter)",callback:()=>{this.checkVaultIntegrity()}}),this.addCommand({id:"o2a-sync-current-file",name:"Sync Current File (Force Update)",callback:()=>{let n=this.app.workspace.getActiveFile();if(n){let e=this.app.vault.adapter;if(e.getBasePath){let a=u.join(e.getBasePath(),n.path);this.runSync(!1,a,!0)}else new s.Notice("Error: Cannot resolve file path.")}else new s.Notice("No active file to sync.")}}),this.addCommand({id:"o2a-sync-prune",name:"Sync with Prune",callback:()=>{this.runSync(!0)}}),this.addSettingTab(new v(this.app,this))}onunload(){}updateStatusBar(t,n){this.statusBarItem&&(this.statusBarItem.empty(),t!=="idle"&&(t==="syncing"?(this.statusBarItem.createSpan({cls:"o2a-sb-icon",text:"\u{1F504} "}),this.statusBarItem.createSpan({text:"Anki Syncing..."})):t==="success"?(this.statusBarItem.setText("\u2705 Sync Complete"),setTimeout(()=>this.updateStatusBar("idle"),3e3)):t==="error"&&(this.statusBarItem.setText("\u274C Sync Error"),this.statusBarItem.title=n||"Check logs")))}async runCheck(t){new s.Notice("Checking file...");let n=this.settings.pythonPath||"python3",e=this.settings.o2aScriptPath||"",a=n,i=[],d=Object.assign({},process.env);if(e&&e.endsWith(".py")){let c=u.dirname(e),o=u.dirname(c);d.PYTHONPATH=o,i.push("-m"),i.push("o2a"),i.push("check-file")}else i.push("-m"),i.push("o2a"),i.push("check-file");i.push(t),i.push("--json");try{let c=(0,b.spawn)(a,i,{env:d}),o="",r="";c.stdout.on("data",k=>o+=k.toString()),c.stderr.on("data",k=>r+=k.toString()),c.on("close",k=>{try{let m=JSON.parse(o);new E(this.app,this,m,t).open()}catch(m){console.error("Failed to parse check output",o),new s.Notice("Check failed. See console.")}})}catch(c){new s.Notice(`Error: ${c.message}`)}}async runSync(t=!1,n=null,e=!1){this.updateStatusBar("syncing");let a=n?"Sycing file...":"Starting o2a sync...";new s.Notice(a);let i=this.app.vault.adapter;if(!i.getBasePath){new s.Notice("Error: Cannot determine vault path."),this.updateStatusBar("error","No Vault Path");return}let d=i.getBasePath(),c=this.manifest.dir||".obsidian/plugins/obsidian-2-anki",o=u.join(d,c,"o2a_plugin.log"),r=g=>{let y=`[${new Date().toISOString()}] ${g}
`;console.log(g);try{require("fs").appendFileSync(o,y)}catch(S){console.error("Failed to write to log file",S)}};r(`

=== STARTING NEW SYNC RUN ===`),r(`Vault: ${d}`);let k=this.settings.pythonPath||"python3",m=this.settings.o2aScriptPath||"",x=k,l=[],A=Object.assign({},process.env);if(m&&m.endsWith(".py")){r(`Trace: Detected .py script: ${m}`);let g=u.dirname(m),f=u.dirname(g);r(`Trace: Derived package root (PYTHONPATH): ${f}`),A.PYTHONPATH=f,l.push("-m"),l.push("o2a"),this.settings.debugMode&&l.push("--verbose"),l.push("sync")}else m?(r(`Trace: Using custom script/binary: ${m}`),l.push(m),this.settings.debugMode&&l.push("--verbose"),l.push("sync")):(r("Trace: No script path provided. Defaulting to 'python -m o2a'"),l.push("-m"),l.push("o2a"),this.settings.debugMode&&l.push("--verbose"),l.push("sync"));t&&l.push("--prune"),e&&l.push("--force"),this.settings.backend&&this.settings.backend!=="auto"&&(l.push("--backend"),l.push(this.settings.backend)),this.settings.workers&&(l.push("--workers"),l.push(this.settings.workers.toString())),l.push(n||d),r(`Spawning: ${x} ${l.join(" ")}`);try{let g=(0,b.spawn)(x,l,{cwd:d,env:A}),f="";g.stdout.on("data",y=>{y.toString().split(`
`).forEach(C=>{C&&r(`STDOUT: ${C}`)})}),g.stderr.on("data",y=>{let S=y.toString();f+=S,S.split(`
`).forEach(T=>{T&&r(`STDERR: ${T}`)})}),g.on("close",y=>{r(`Process exited with code ${y}`),y===0?(new s.Notice("o2a sync completed successfully!"),this.updateStatusBar("success")):(this.updateStatusBar("error"),f.includes("AnkiConnect call failed")||f.includes("Connection refused")?new s.Notice("Error: Anki is not reachable. Is Anki open with AnkiConnect?"):f.includes("ModuleNotFoundError")?new s.Notice("Error: Python Dependencies missing. Check Python Executable path."):f.includes("No module named")?new s.Notice("Error: Invalid Python environment or o2a not installed."):new s.Notice(`o2a sync failed! (Code ${y}). See log.`))}),g.on("error",y=>{r(`Process Error: ${y.message}`),new s.Notice(`Failed to start: ${y.message}`),this.updateStatusBar("error",y.message)})}catch(g){r(`Exception during spawn: ${g.message}`),new s.Notice(`Exception: ${g.message}`),this.updateStatusBar("error",g.message)}}async testConfig(){new s.Notice("Testing configuration...");let t=this.settings.pythonPath||"python3";try{let n=(0,b.spawn)(t,["--version"]);n.on("close",e=>{e===0?new s.Notice("Success: Python found."):new s.Notice("Error: Python command failed.")}),n.on("error",e=>{new s.Notice(`Error: Invalid Python Path. ${e.message}`)})}catch(n){new s.Notice(`Error: ${n.message}`)}}async loadSettings(){this.settings=Object.assign({},H,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async runFix(t){let n=this.settings,e=n.pythonPath||"python3",a=n.o2aScriptPath,i="",d=[];if(a&&a.endsWith(".py")){let o=u.dirname(n.o2aScriptPath);i=e,d=["-m","o2a","fix-file",t]}else i=e,d=["-m","o2a","fix-file",t];let c=Object.assign({},process.env);if(a&&a.endsWith(".py")){let o=u.dirname(a),r=u.dirname(o);c.PYTHONPATH=r}return new Promise(o=>{(0,b.spawn)(i,d,{env:c}).on("close",k=>{k===0?new s.Notice("\u2728 File auto-fixed!"):new s.Notice("\u274C Fix failed (check console)"),o()})})}async checkVaultIntegrity(){new s.Notice("Running Integrity Check...");let t=this.app.vault.getMarkdownFiles(),n=0,e=0;console.log("--- O2A Integrity Check ---");for(let a of t){e++;let i=this.app.metadataCache.getFileCache(a);(await this.app.vault.read(a)).startsWith(`---
`)&&(!i||!i.frontmatter)&&(console.error(`[FAIL] ${a.path}: Has YAML block, but Obsidian Cache has no frontmatter! (Likely Invalid Properties)`),n++)}console.log(`Integrity Check Complete. ${e} files checked. ${n} potential issues.`),n>0?new s.Notice(`Found ${n} files with Invalid Properties (Check Console)`):new s.Notice("Integrity Check Passed (Obsidian parses all YAML correctly)")}},v=class extends s.PluginSettingTab{constructor(t,n){super(t,n);this.plugin=n}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"O2A Settings"}),new s.Setting(t).setName("Python Executable").setDesc("Path to python3 or o2a executable").addText(e=>e.setPlaceholder("python3").setValue(this.plugin.settings.pythonPath).onChange(async a=>{this.plugin.settings.pythonPath=a,await this.plugin.saveSettings()})),new s.Setting(t).setName("O2A Script Path").setDesc("Absolute path to o2a/main.py. Leave empty if you are using a global binary.").addText(e=>e.setPlaceholder("/path/to/o2a/main.py").setValue(this.plugin.settings.o2aScriptPath).onChange(async a=>{this.plugin.settings.o2aScriptPath=a,await this.plugin.saveSettings()})),new s.Setting(t).setName("Debug Mode").setDesc("Enable verbose logging and extra output.").addToggle(e=>e.setValue(this.plugin.settings.debugMode).onChange(async a=>{this.plugin.settings.debugMode=a,await this.plugin.saveSettings()})),new s.Setting(t).setName("Anki Backend").setDesc("Manual override for the Anki sync driver.").addDropdown(e=>e.addOption("auto","Auto (Recommended)").addOption("apy","Apy (Direct DB Access, Faster)").addOption("ankiconnect","AnkiConnect (Requires Anki running)").setValue(this.plugin.settings.backend).onChange(async a=>{this.plugin.settings.backend=a,await this.plugin.saveSettings()})),new s.Setting(t).setName("Parallel Workers").setDesc("Number of parallel sync workers. Higher is faster but may stress AnkiConnect.").addSlider(e=>e.setLimits(1,16,1).setValue(this.plugin.settings.workers).setDynamicTooltip().onChange(async a=>{this.plugin.settings.workers=a,await this.plugin.saveSettings()})),new s.Setting(t).setName("Test Configuration").setDesc("Verifies that the Python Executable is valid.").addButton(e=>e.setButtonText("Test Config").onClick(async()=>{await this.plugin.testConfig()})),t.createEl("h2",{text:"Hotkeys"}),t.createEl("p",{text:"To modify hotkeys, click the button to open Obsidian Hotkey settings."}),[{id:"obsidian-2-anki:o2a-sync",name:"Sync"},{id:"obsidian-2-anki:o2a-sync-current-file",name:"Sync Current File"},{id:"obsidian-2-anki:o2a-sync-prune",name:"Sync with Prune"}].forEach(e=>{let a=this.app.commands.findCommand(e.id);if(!a)return;let d=(a.hotkeys||[]).map(c=>`${c.modifiers.join("+")}+${c.key}`).join(", ")||"No hotkey set";new s.Setting(t).setName(e.name).setDesc(`Current: ${d}`).addButton(c=>c.setButtonText("Configure").onClick(()=>{this.app.setting.openTabById("hotkeys");let o=this.app.setting.activeTab;o&&o.searchComponent&&(o.searchComponent.setValue("o2a"),o.updateHotkeyVisibility())}))})}},E=class extends s.Modal{constructor(t,n,e,a){super(t);this.plugin=n,this.result=e,this.filePath=a}onOpen(){let{contentEl:t}=this;t.addClass("o2a-modal");let n=t.createDiv({cls:"modal-header"});if(n.createEl("h2",{text:"O2A File Check"}),n.createEl("span",{text:u.basename(this.filePath),cls:"o2a-filename"}),this.result.ok){t.createDiv({text:"\u2705 Valid",cls:"o2a-success"});let e=t.createEl("ul",{cls:"o2a-stats"}),a=e.createEl("li");a.createSpan({text:"Deck",cls:"o2a-stats-label"}),a.createSpan({text:this.result.stats.deck||"None",cls:"o2a-stats-val"});let i=e.createEl("li");i.createSpan({text:"Cards Found",cls:"o2a-stats-label"}),i.createSpan({text:this.result.stats.cards_found.toString(),cls:"o2a-stats-val"})}else{t.createDiv({text:"\u274C Validation Failed",cls:"o2a-error"});let e=t.createEl("table",{cls:"o2a-error-table"}),i=e.createEl("thead").createEl("tr");i.createEl("th",{text:"Line"}),i.createEl("th",{text:"Error Message"});let d=e.createEl("tbody"),c=!1;if(this.result.errors.forEach(o=>{let r=d.createEl("tr");r.createEl("td",{text:o.line.toString(),cls:"o2a-error-line"}),r.createEl("td",{text:o.message,cls:"o2a-err-msg"}),(o.message.includes("Tab Character Error")||o.message.includes("Missing 'cards' list"))&&(c=!0)}),c){let r=t.createDiv({cls:"o2a-btn-container",attr:{style:"margin-top: 1rem; text-align: right;"}}).createEl("button",{text:"\u2728 Auto-Fix Issues",cls:"mod-cta"});r.addEventListener("click",async()=>{r.disabled=!0,r.setText("Fixing..."),await this.plugin.runFix(this.filePath),this.close(),this.plugin.runCheck(this.filePath)})}t.createDiv({text:'\u{1F4A1} Tip: Check for correct YAML indentation (2 spaces) and ensure "cards" list exists.',cls:"o2a-hint"})}}onClose(){let{contentEl:t}=this;t.empty()}};
