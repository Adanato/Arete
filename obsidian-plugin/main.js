/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository
*/

var I=Object.create;var b=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var $=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var N=(l,d)=>{for(var t in d)b(l,t,{get:d[t],enumerable:!0})},B=(l,d,t,s)=>{if(d&&typeof d=="object"||typeof d=="function")for(let e of D(d))!O.call(l,e)&&e!==t&&b(l,e,{get:()=>d[e],enumerable:!(s=F(d,e))||s.enumerable});return l};var M=(l,d,t)=>(t=l!=null?I($(l)):{},B(d||!l||!l.__esModule?b(t,"default",{value:l,enumerable:!0}):t,l)),V=l=>B(b({},"__esModule",{value:!0}),l);var j={};N(j,{default:()=>w});module.exports=V(j);var n=require("obsidian"),P=require("child_process"),u=M(require("path")),H={pythonPath:"python3",o2aScriptPath:"",debugMode:!1},w=class extends n.Plugin{async onload(){await this.loadSettings(),this.statusBarItem=this.addStatusBarItem(),this.updateStatusBar("idle");let t=this.addRibbonIcon("sheets-in-box","Sync to Anki (o2a)",s=>{this.runSync()});this.addCommand({id:"o2a-sync",name:"Sync",hotkeys:[{modifiers:["Mod","Shift"],key:"A"}],callback:()=>{this.runSync()}}),this.addCommand({id:"o2a-check-file",name:"Check Current File",editorCallback:(s,e)=>{if(e.file){let a=this.app.vault.adapter;if(a.getBasePath){let i=u.join(a.getBasePath(),e.file.path);this.runCheck(i)}}}}),this.addCommand({id:"o2a-check-integrity",name:"Debug: Check Vault Integrity (Obsidian vs Linter)",callback:()=>{this.checkVaultIntegrity()}}),this.addCommand({id:"o2a-sync-current-file",name:"Sync Current File (Force Update)",callback:()=>{let s=this.app.workspace.getActiveFile();if(s){let e=this.app.vault.adapter;if(e.getBasePath){let a=u.join(e.getBasePath(),s.path);this.runSync(!1,a,!0)}else new n.Notice("Error: Cannot resolve file path.")}else new n.Notice("No active file to sync.")}}),this.addCommand({id:"o2a-sync-prune",name:"Sync with Prune",callback:()=>{this.runSync(!0)}}),this.addSettingTab(new E(this.app,this))}onunload(){}updateStatusBar(t,s){this.statusBarItem&&(this.statusBarItem.empty(),t!=="idle"&&(t==="syncing"?(this.statusBarItem.createSpan({cls:"o2a-sb-icon",text:"\u{1F504} "}),this.statusBarItem.createSpan({text:"Anki Syncing..."})):t==="success"?(this.statusBarItem.setText("\u2705 Sync Complete"),setTimeout(()=>this.updateStatusBar("idle"),3e3)):t==="error"&&(this.statusBarItem.setText("\u274C Sync Error"),this.statusBarItem.title=s||"Check logs")))}async runCheck(t){new n.Notice("Checking file...");let s=this.settings.pythonPath||"python3",e=this.settings.o2aScriptPath||"",a=s,i=[],h=Object.assign({},process.env);if(e&&e.endsWith(".py")){let c=u.dirname(e),o=u.dirname(c);h.PYTHONPATH=o,i.push("-m"),i.push("o2a"),i.push("check-file")}else i.push("-m"),i.push("o2a"),i.push("check-file");i.push(t),i.push("--json");try{let c=(0,P.spawn)(a,i,{env:h}),o="",r="";c.stdout.on("data",S=>o+=S.toString()),c.stderr.on("data",S=>r+=S.toString()),c.on("close",S=>{try{let m=JSON.parse(o);new v(this.app,this,m,t).open()}catch(m){console.error("Failed to parse check output",o),new n.Notice("Check failed. See console.")}})}catch(c){new n.Notice(`Error: ${c.message}`)}}async runSync(t=!1,s=null,e=!1){this.updateStatusBar("syncing");let a=s?"Sycing file...":"Starting o2a sync...";new n.Notice(a);let i=this.app.vault.adapter;if(!i.getBasePath){new n.Notice("Error: Cannot determine vault path."),this.updateStatusBar("error","No Vault Path");return}let h=i.getBasePath(),c=this.manifest.dir||".obsidian/plugins/obsidian-2-anki",o=u.join(h,c,"o2a_plugin.log"),r=g=>{let y=`[${new Date().toISOString()}] ${g}
`;console.log(g);try{require("fs").appendFileSync(o,y)}catch(k){console.error("Failed to write to log file",k)}};r(`

=== STARTING NEW SYNC RUN ===`),r(`Vault: ${h}`);let S=this.settings.pythonPath||"python3",m=this.settings.o2aScriptPath||"",x=S,p=[],T=Object.assign({},process.env);if(m&&m.endsWith(".py")){r(`Trace: Detected .py script: ${m}`);let g=u.dirname(m),f=u.dirname(g);r(`Trace: Derived package root (PYTHONPATH): ${f}`),T.PYTHONPATH=f,p.push("-m"),p.push("o2a"),p.push("sync")}else m?(r(`Trace: Using custom script/binary: ${m}`),p.push(m),p.push("sync")):(r("Trace: No script path provided. Defaulting to 'python -m o2a'"),p.push("-m"),p.push("o2a"),p.push("sync"));t&&p.push("--prune"),e&&p.push("--force"),this.settings.debugMode&&p.push("--verbose"),p.push(s||h),r(`Spawning: ${x} ${p.join(" ")}`);try{let g=(0,P.spawn)(x,p,{cwd:h,env:T}),f="";g.stdout.on("data",y=>{y.toString().split(`
`).forEach(C=>{C&&r(`STDOUT: ${C}`)})}),g.stderr.on("data",y=>{let k=y.toString();f+=k,k.split(`
`).forEach(A=>{A&&r(`STDERR: ${A}`)})}),g.on("close",y=>{r(`Process exited with code ${y}`),y===0?(new n.Notice("o2a sync completed successfully!"),this.updateStatusBar("success")):(this.updateStatusBar("error"),f.includes("AnkiConnect call failed")||f.includes("Connection refused")?new n.Notice("Error: Anki is not reachable. Is Anki open with AnkiConnect?"):f.includes("ModuleNotFoundError")?new n.Notice("Error: Python Dependencies missing. Check Python Executable path."):f.includes("No module named")?new n.Notice("Error: Invalid Python environment or o2a not installed."):new n.Notice(`o2a sync failed! (Code ${y}). See log.`))}),g.on("error",y=>{r(`Process Error: ${y.message}`),new n.Notice(`Failed to start: ${y.message}`),this.updateStatusBar("error",y.message)})}catch(g){r(`Exception during spawn: ${g.message}`),new n.Notice(`Exception: ${g.message}`),this.updateStatusBar("error",g.message)}}async testConfig(){new n.Notice("Testing configuration...");let t=this.settings.pythonPath||"python3";try{let s=(0,P.spawn)(t,["--version"]);s.on("close",e=>{e===0?new n.Notice("Success: Python found."):new n.Notice("Error: Python command failed.")}),s.on("error",e=>{new n.Notice(`Error: Invalid Python Path. ${e.message}`)})}catch(s){new n.Notice(`Error: ${s.message}`)}}async loadSettings(){this.settings=Object.assign({},H,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async runFix(t){let s=this.settings,e=s.pythonPath||"python3",a=s.o2aScriptPath,i="",h=[];if(a&&a.endsWith(".py")){let o=u.dirname(s.o2aScriptPath);i=e,h=["-m","o2a","fix-file",t]}else i=e,h=["-m","o2a","fix-file",t];let c=Object.assign({},process.env);if(a&&a.endsWith(".py")){let o=u.dirname(a),r=u.dirname(o);c.PYTHONPATH=r}return new Promise(o=>{(0,P.spawn)(i,h,{env:c}).on("close",S=>{S===0?new n.Notice("\u2728 File auto-fixed!"):new n.Notice("\u274C Fix failed (check console)"),o()})})}async checkVaultIntegrity(){new n.Notice("Running Integrity Check...");let t=this.app.vault.getMarkdownFiles(),s=0,e=0;console.log("--- O2A Integrity Check ---");for(let a of t){e++;let i=this.app.metadataCache.getFileCache(a);(await this.app.vault.read(a)).startsWith(`---
`)&&(!i||!i.frontmatter)&&(console.error(`[FAIL] ${a.path}: Has YAML block, but Obsidian Cache has no frontmatter! (Likely Invalid Properties)`),s++)}console.log(`Integrity Check Complete. ${e} files checked. ${s} potential issues.`),s>0?new n.Notice(`Found ${s} files with Invalid Properties (Check Console)`):new n.Notice("Integrity Check Passed (Obsidian parses all YAML correctly)")}},E=class extends n.PluginSettingTab{constructor(t,s){super(t,s);this.plugin=s}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"O2A Settings"}),new n.Setting(t).setName("Python Executable").setDesc("Path to python3 or o2a executable").addText(e=>e.setPlaceholder("python3").setValue(this.plugin.settings.pythonPath).onChange(async a=>{this.plugin.settings.pythonPath=a,await this.plugin.saveSettings()})),new n.Setting(t).setName("O2A Script Path").setDesc("Absolute path to o2a/main.py. Leave empty if you are using a global binary.").addText(e=>e.setPlaceholder("/path/to/o2a/main.py").setValue(this.plugin.settings.o2aScriptPath).onChange(async a=>{this.plugin.settings.o2aScriptPath=a,await this.plugin.saveSettings()})),new n.Setting(t).setName("Debug Mode").setDesc("Enable verbose logging and extra output.").addToggle(e=>e.setValue(this.plugin.settings.debugMode).onChange(async a=>{this.plugin.settings.debugMode=a,await this.plugin.saveSettings()})),new n.Setting(t).setName("Test Configuration").setDesc("Verifies that the Python Executable is valid.").addButton(e=>e.setButtonText("Test Config").onClick(async()=>{await this.plugin.testConfig()})),t.createEl("h2",{text:"Hotkeys"}),t.createEl("p",{text:"To modify hotkeys, click the button to open Obsidian Hotkey settings."}),[{id:"obsidian-2-anki:o2a-sync",name:"Sync"},{id:"obsidian-2-anki:o2a-sync-current-file",name:"Sync Current File"},{id:"obsidian-2-anki:o2a-sync-prune",name:"Sync with Prune"}].forEach(e=>{let a=this.app.commands.findCommand(e.id);if(!a)return;let h=(a.hotkeys||[]).map(c=>`${c.modifiers.join("+")}+${c.key}`).join(", ")||"No hotkey set";new n.Setting(t).setName(e.name).setDesc(`Current: ${h}`).addButton(c=>c.setButtonText("Configure").onClick(()=>{this.app.setting.openTabById("hotkeys");let o=this.app.setting.activeTab;o&&o.searchComponent&&(o.searchComponent.setValue("o2a"),o.updateHotkeyVisibility())}))})}},v=class extends n.Modal{constructor(t,s,e,a){super(t);this.plugin=s,this.result=e,this.filePath=a}onOpen(){let{contentEl:t}=this;t.addClass("o2a-modal");let s=t.createDiv({cls:"modal-header"});if(s.createEl("h2",{text:"O2A File Check"}),s.createEl("span",{text:u.basename(this.filePath),cls:"o2a-filename"}),this.result.ok){t.createDiv({text:"\u2705 Valid",cls:"o2a-success"});let e=t.createEl("ul",{cls:"o2a-stats"}),a=e.createEl("li");a.createSpan({text:"Deck",cls:"o2a-stats-label"}),a.createSpan({text:this.result.stats.deck||"None",cls:"o2a-stats-val"});let i=e.createEl("li");i.createSpan({text:"Cards Found",cls:"o2a-stats-label"}),i.createSpan({text:this.result.stats.cards_found.toString(),cls:"o2a-stats-val"})}else{t.createDiv({text:"\u274C Validation Failed",cls:"o2a-error"});let e=t.createEl("table",{cls:"o2a-error-table"}),i=e.createEl("thead").createEl("tr");i.createEl("th",{text:"Line"}),i.createEl("th",{text:"Error Message"});let h=e.createEl("tbody"),c=!1;if(this.result.errors.forEach(o=>{let r=h.createEl("tr");r.createEl("td",{text:o.line.toString(),cls:"o2a-error-line"}),r.createEl("td",{text:o.message,cls:"o2a-err-msg"}),(o.message.includes("Tab Character Error")||o.message.includes("Missing 'cards' list"))&&(c=!0)}),c){let r=t.createDiv({cls:"o2a-btn-container",attr:{style:"margin-top: 1rem; text-align: right;"}}).createEl("button",{text:"\u2728 Auto-Fix Issues",cls:"mod-cta"});r.addEventListener("click",async()=>{r.disabled=!0,r.setText("Fixing..."),await this.plugin.runFix(this.filePath),this.close(),this.plugin.runCheck(this.filePath)})}t.createDiv({text:'\u{1F4A1} Tip: Check for correct YAML indentation (2 spaces) and ensure "cards" list exists.',cls:"o2a-hint"})}}onClose(){let{contentEl:t}=this;t.empty()}};
