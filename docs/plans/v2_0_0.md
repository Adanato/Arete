# Arete v2.0.0 â€” Implementation Plan
Dependency-aware learning built on top of Obsidian-authored cards and Anki scheduling.

---

## Core Design Principles

1. **Obsidian/YAML is the source of truth**
2. **Each card has a single, stable Arete ID**
3. **Anki IDs (nid/cid) are downstream mappings**
4. **Dependencies are explicit and user-authored**
5. **Anki schedules when; Arete guides what order makes sense**

---

## Mental Model

- **Concept Markdown**
  - Semantic container for one idea
  - Groups related cards (facets of the same concept)
  - Optional concept-level dependencies (coarse)

- **Card**
  - Atomic review unit
  - Has:
    - stable Arete ID
    - content (fields)
    - optional Anki mapping
    - explicit dependencies on other cards

- **Dependency Graph**
  - Nodes = cards
  - Edges:
    - `requires` â†’ prerequisite (ordering constraint)
    - `related` â†’ associative (no ordering)

---

## 1. Schema Design (v2)

### 1.1 Card Identity

Each card owns a **stable Arete ID**, generated and managed automatically.

```yaml
cards:
  - id: arete_01JH8Y3ZK4QJ9W6E2N8F6M0P5R
    model: Basic

    Front: "What is the horizon line?"
    Back: "It represents the viewerâ€™s eye level."
    deps:
      requires: []
      related: []
    anki:
      nid: 1701234567890
      cid: 1701234567891
```

**Invariants**
- `id` is required and never changes
- Dependencies reference `id`
- Anki IDs are optional mappings only

### 1.2 Concept Markdown (Container)
Concept notes group cards that probe the same idea from different angles.

```yaml
concept:
  title: "Horizon Line"
  domain: art/perspective
  deps:
    requires:
      - perspective_eye_level
```

**Concept notes:**
- do not define review units
- do not replace cards
- exist to provide structure, navigation, and higher-level deps

### 1.3 Dependency Semantics
```yaml
deps:
  requires: [arete_xxx]   # must be understood first
  related:  [arete_yyy]   # conceptually associated
```

**Rules:**
- `requires` participates in learning order
- `related` is non-ordering
- cycles are allowed but flagged as co-requisites

### 1.4 Migration (v1 â†’ v2)
**Migration command:**
```bash
arete migrate v2
```

**Steps:**
1. Generate Arete ID for any card missing one
2. Normalize fields under `fields`
3. Preserve existing Anki mappings
4. Initialize empty `deps` if missing
5. Validate uniqueness of IDs

*Dry-run mode shows diff before write.*

---

## 2. Dependency Editing UX

### 2.1 Dependency Panel (Primary Editor)
A dedicated panel for the selected card.

**Features:**
- list `requires` and `related`
- add/remove dependencies via search
- show diagnostics:
    - missing card
    - cycle detected
    - excessive prerequisites

*User never edits raw IDs manually.*

### 2.2 Add Dependency Flow
1. User clicks â€œAdd prerequisiteâ€ or â€œAdd relatedâ€
2. Fuzzy search across all cards
3. Preview card content + location
4. Insert referenced Arete ID into YAML

### 2.3 Gutter Indicators (Editor Feedback)
Per-card gutter markers:
- ğŸ”— has prerequisites
- âš ï¸ missing prerequisite
- âš”ï¸ cycle / co-requisite
- ğŸŒ±ğŸŒ¿ğŸŒ³ maturity (derived from Anki stats)
- ğŸ”„ edited since last Anki sync

---

## 3. Local Dependency Graph View

### 3.1 Scope
Local subgraph centered on a selected card:
- prerequisites (`requires`)
- dependents (reverse `requires`)
- related (optional toggle)

**Limits:**
- max depth (default: 2)
- max nodes (default: 150)

### 3.2 Layout
Dependency-readable layout (not force blob):
- **left**: prerequisites
- **center**: selected card
- **right**: dependents
- **dotted edges**: related

### 3.3 Interactions
- click node â†’ open note + scroll to card
- hover â†’ preview + stats
- toggle requires / related
- highlight cycles and missing nodes

---

## 4. Dependency-Aware Anki Study Queues

### 4.1 Role Separation
- **Anki**: scheduling (FSRS untouched)
- **Arete**: learning order and dependency health

### 4.2 â€œTodayâ€™s Dependency Queueâ€
**Workflow:**
1. Query Anki for due cards
2. Resolve prerequisite closure via `requires`
3. Identify weak prerequisites
4. Create temporary study queues:
    - **Arete â€“ Today: Prereqs**
    - **Arete â€“ Today: Main**
5. User studies prereqs first, then main.

### 4.3 Weak Prerequisite Heuristics (v2)
A prerequisite is â€œweakâ€ if:
- low stability
- recent lapse
- few total reviews
- edited since last sync

*Thresholds configurable.*

### 4.4 Failure Handling
- **missing prereq** â†’ warn, continue
- **cycles** â†’ treat group as bundle
- **large closure** â†’ include only weakest K prereqs

---

## 5. Indexing & Performance
Maintain card index:
`id â†’ file, position, deps, Anki mapping`

**Rebuild on:**
- file changes
- migration
- explicit reindex command

*Dependency traversal is on-demand only*

---

## 6. Release Milestones

### Milestone 1 â€” Schema & Migration (Required)
- [ ] Arete ID generation
- [ ] v1 â†’ v2 migration
- [ ] schema validation

### Milestone 2 â€” Dependency Editing (Required)
- [ ] dependency panel
- [ ] add/remove requires & related
- [ ] diagnostics + gutter indicators

### Milestone 3 â€” Local Graph View (v2 Highlight)
- [ ] local dependency graph
- [ ] navigation + toggles

### Milestone 4 â€” Anki Queue Builder (Required)
- [ ] prereq resolution
- [ ] filtered deck / tag-based queues
- [ ] summary report

### Milestone 5 â€” Docs & Polish
- [ ] schema documentation
- [ ] dependency modeling guide
- [ ] examples & anti-patterns

---

## 7. Modeling Guidelines (User-Facing)
- Use `requires` sparingly (true prerequisites only)
- Use `related` for reinforcement and association
- If a card has too many prerequisites â†’ split it
- Concept notes should group facets, not taxonomies

### Success Criteria
- Cards can be linked before exporting to Anki
- Dependency graph survives re-imports
- Users can see why a card feels hard
- Learning order improves without fighting Ankiâ€™s scheduler
