# Arete v2.1.0 — Technical Debt & Maintenance

*Sharpening the tool for the Agentic future.*

---

## Core Vision

v2.0 delivered rebranding and stability. v2.1 pays down internal debt so the v3.0 Agentic Layer has a clean, modular base. The first round of audit fixes (I2, I1, I6, F4) is complete — SQL injection, layer violations, connection reuse, and CLI deduplication are all resolved. What remains is **complexity reduction** across 14 god functions and documentation cleanup.

## Completed (Pre-v2.1 Audit)

- [x] **I2**: Parameterized all SQL queries in `direct_stats.py`
- [x] **I1**: Moved `LearningStats` / `NoteInsight` to `domain/stats/models.py`; removed circular import in `anki_connect.py`
- [x] **I6**: httpx client reuse in `ConnectStatsRepository` and `AnkiConnectAdapter.is_responsive()`
- [x] **F4**: Extracted `_parse_cids()` and `_run_anki_bridge_action()` helpers in CLI
- [x] **Tests**: Fixed `Tab Error.md` and `Missing Keys.md` mock vault fixtures; 470 passing, 85.56% coverage

---

## Roadmap

### Milestone 1: Breaking the God Functions (Tier 1)

Target the 4 functions scoring 20+ on McCabe C901. Goal: every function below 15.

| Function | Score | Refactoring Strategy |
| :--- | ---: | :--- |
| `pipeline.run_pipeline` | 25 | Split into `_setup_pipeline`, `_run_producers`, `_run_consumers` phases. Extract retry/error handling into a decorator or context manager. |
| `vault_service.apply_updates` | 21 | Extract write-back logic into `_write_card_updates()` and `_write_metadata_updates()`. Use a strategy dict for update types. |
| `pipeline._prune_orphans` | 20 | Extract orphan-detection query into `_find_orphan_notes()` and deletion logic into `_delete_orphan_notes()`. |
| `parser.parse_file` | 20 | Extract YAML validation into `_validate_card_schema()` and card-building into `_build_card_from_dict()`. |

**Verification**: `uv run ruff check src/arete/ --select C901` shows no function above 15.

### Milestone 2: Breaking the God Functions (Tier 2)

Target the 6 functions scoring 13-19. Goal: every function at or below 10.

| Function | Score | Refactoring Strategy |
| :--- | ---: | :--- |
| `graph_resolver.build_graph` | 19 | Extract edge-building into `_resolve_edges()` and cycle detection into `_detect_cycles()`. |
| `text.apply_fixes` | 18 | Split into per-fix-type handlers (`_fix_block_scalars`, `_fix_mathjax`, `_fix_ids`). Dispatch via a list of fix functions. |
| `vault_service._quick_check_file` | 15 | Extract YAML check into `_check_yaml_syntax()` and field validation into `_check_required_fields()`. |
| `graph_resolver.get_local_graph` | 14 | Extract neighbor collection into `_collect_neighbors()`. |
| `queue_builder.build_dependency_queue` | 14 | Extract topological sort into `_topo_sort()` and dependency resolution into `_resolve_deps()`. |
| `text.parse_frontmatter` | 13 | Extract card-list parsing into `_parse_card_list()`. |

**Verification**: `uv run ruff check src/arete/ --select C901` returns 0 violations.

### Milestone 3: Documentation & Type Coverage

Address the 191 D-series ruff violations.

- [ ] Add module-level docstrings to all `src/arete/` packages (D100, D104 — 28 violations)
- [ ] Add docstrings to public classes and methods in `domain/` (D101, D102 — 64 violations)
- [ ] Fix formatting: blank lines after summaries, imperative mood, trailing periods (D205, D401, D400, D415 — 64 violations)
- [ ] Add `__init__` docstrings where non-trivial (D107 — 11 violations)
- [ ] Remaining minor rules (D103, D105, D301 — 24 violations)
- [ ] Enable stricter D-series rules in `pyproject.toml` (remove global D100-D104 ignores, keep per-file exceptions only where justified)

**Verification**: `uv run ruff check src/arete/ --select D` returns 0 violations.

### Milestone 4: Security & Dependency Hygiene

- [ ] Merge Dependabot updates for GitHub Actions
- [ ] Resolve vulnerabilities in `obsidian-plugin` (NPM dependencies)
- [ ] Update dev tools: `ruff` (latest), `import-linter` (latest)
- [ ] Sync all lockfiles (`uv lock`, `npm install`)
- [ ] Decouple `AnkiConnectAdapter` from `httpx` directly — introduce a thin `HttpClient` protocol for testability

**Verification**: `uv audit` clean, `npm audit` clean, `just qa` zero warnings.

---

## Success Criteria

1. **Zero C901 violations**: No function in `src/arete/` exceeds complexity 10.
2. **Zero D-series violations**: Full docstring coverage and formatting compliance.
3. **Clean QA**: `just qa` runs with zero warnings.
4. **Test health**: Coverage stays above 85%, all tests green.
